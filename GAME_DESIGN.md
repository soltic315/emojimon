# EMOJIMON ゲーム設計書

このドキュメントは Emojimon のゲーム仕様に関する一次情報です。  
実装変更で仕様が変わる場合は、必ず本書を先に更新してからコードへ反映します。

---

## 1. 設計方針

- 対象: ブラウザ上で短時間に遊べる 2D ターン制バトルRPG
- 体験目標:
  - 1バトルのテンポがよい
  - 進行不能が起きない
  - データ駆動で拡張しやすい
- 実装方針:
  - ルールは `js/data` を優先して集約
  - 表示は Scene と `js/ui` で分離
  - データは `assets/data/*.json` を正とする

---

## 2. ドキュメント境界

- 本書に記載するもの
  - ゲームルール、進行条件、数式、パラメータ、仕様上の制約
- 本書に記載しないもの
  - セットアップ手順、開発コマンド、運用フロー（`README.md`に記載）
  - AIの作業規約（`AGENTS.md`に記載）

---

## 3. コアゲームループ

1. ワールド探索
2. エンカウント発生
3. ターン制バトル
4. 成長（経験値・所持金・進化）
5. 次の進行条件へ挑戦

### 3.1 新規開始フロー

- タイトルの「はじめから」選択時は、フィールド表示の前にプロローグ演出を再生し、終了後は研究所（LAB）から開始する
- 研究所（LAB）に到着した直後、博士の説明イベントが自動で開始される
- スターターモンスターを選ぶまで、研究所（LAB）から町（EMOJI_TOWN）へは出られない
- 研究所のスターター台座は、モンスター絵文字のみを表示し、種別テキストや通常NPCアイコンは重ね表示しない
- モンスターデータでは全モンスターに `sub_emoji` フィールドを持たせる（空配列可）
- 単体表示で重ね描画を行う場合は `sub_emoji` を明示指定する（暗黙的な2グラフェム自動重ねは行わない）
- 例: `"sub_emoji": [{"emoji":"❄️","point":"top-right","size":0.5}]`
- `sub_emoji[].point` は位置キーワード（`center` / `top-right` など）または座標（`{ "x": number, "y": number }`）を許可する
- モンスター未所持の状態では、フィールド（FOREST）へ遷移できない
- プロローグ完了後に `WorldScene`（研究所/LAB）へ遷移する
- 初回ナレーション完了フラグ（`storyFlags.introNarrationDone`）はプロローグ終了時に立つ

---

## 4. フィールド仕様

### 4.1 タイルコード

| コード | 種別 | 説明 |
|---|---|---|
| 0 | 地面 | 歩行可能 |
| 1 | 壁 | 通行不可 |
| 2 | 草むら | エンカウント判定対象 |
| 3 | ドア | マップ遷移 |
| 4 | 森 | 低確率エンカウント判定対象 |
| 5 | 水 | 通行不可（装飾/ギミック対象） |
| 6 | ジム | 互換用イベントタイル（現行は主にジムNPC起点） |
| 7 | 道 | 歩行可能 |
| 8 | 毒沼 | 歩行可能・エンカウント判定対象。歩行ごとにパーティ全員にダメージ（3HP） |
| 9 | テレポート | 歩行可能。踏むとペアのパッドへワープ |
| 10 | 氷床 | 歩行可能。踏むと壁か非氷タイルまで滑り続ける |
| 11 | 暗闇 | 歩行可能。でんきタイプ不在時は視界制限オーバーレイが表示される |
| 12 | 砂地 | 歩行可能。低確率エンカウント（8%基本） |

### 4.2 基本操作

| キー | 用途 |
|---|---|
| ←↑→↓ / WASD | 移動 |
| Z / Space | 決定・会話 |
| X / ESC | メニュー / キャンセル |
| P | セーブ |

- バトル中、メッセージ表示中に `Z` / `Space`（タッチではAボタン）を長押しするとメッセージを高速送りする
- メニュー画面では `↑` / `↓` の長押しでカーソルを連続移動できる
- 会話表示は「話者名ウィンドウ」と「本文ウィンドウ」を分離して表示し、本文内に `話者名:` の接頭辞は表示しない
- 研究所のスターター最終確認（はい / いいえ）は、キー直指定ではなく専用の選択ウィンドウで行う
- 研究所イベントおよび初回野生バトルでは、操作ガイド文を自動表示しない

### 4.3 マップ遷移

- ドアタイル踏破で遷移演出を実行
- 遷移時のオートセーブは設定でON/OFFを切替できる
- 主要施設（ショップ・ジム）は屋外建物のドアから屋内マップへ遷移する
- 施設NPC（店員・ジムリーダー）は原則として屋内マップに配置する

### 4.4 探索アクション

- FIRE: 特定オブジェクトを解除（氷ブロック溶解）
- WATER: 特定水面の移動解禁（泳ぎ探索）
- ELECTRIC: 暗闇マップの視界確保
- GRASS: 一部隠しアイテム取得に必要
- ICE: 一部隠しアイテム取得に必要
- 取得済みフラグはセーブデータに保持

### 4.4.1 隠し探索ポイント（拡張）

- 隠しアイテムは主要マップごとに複数配置し、タイプ適性（FIRE/WATER/GRASS/ELECTRIC/ICE）を満たすと取得できる
- 既存の探索ポイントに加え、以下を追加する
  - FOREST: 生命の種（GRASS）
  - CRYSTAL_CAVE: 反響鉱石（ELECTRIC）
  - VOLCANIC_PASS: 灼熱欠片（FIRE）
  - FROZEN_PEAK: 氷結薬草（ICE）
  - ANCIENT_LIBRARY: 封庫アーカイブ（ELECTRIC）
  - CELESTIAL_GARDEN: 天空の露（WATER）
  - STARFALL_BASIN: 隕石片（ELECTRIC）

### 4.4.2 地域サブクエスト（拡張）

- 各地の依頼NPCで、探索進捗と戦闘進捗を組み合わせたサブクエストを受注/報告できる
- 追加サブクエスト
  - 湿地の調合依頼（MISTY_SWAMP）
    - 条件: 湿地石板読了 + 薬草回収 + 湿地レンジャー試験突破
    - 報酬: 回復/治療アイテム + 所持金
  - 珊瑚の記録復元（CORAL_REEF）
    - 条件: 珊瑚碑読了 + 真珠回収 + みずタイプ3体クエスト達成
    - 報酬: 捕獲/補助アイテム + 所持金
  - 図書館文献復元（ANCIENT_LIBRARY）
    - 条件: 古代写本読了 + 影のデータ回収 + 図書館封庫探索
    - 報酬: 高位捕獲/回復アイテム + 所持金
  - 星降り観測最終報告（STARFALL_BASIN）
    - 条件: 本編終盤到達 + 星読碑読了 + 星核/隕石片回収
    - 報酬: 最上位報酬アイテム + 所持金

### 4.5 マップ一覧

| マップ名 | サイズ | レベル帯 | 主要ギミック |
|---|---|---|---|
| EMOJI_TOWN（えもじタウン） | 36×28 | - | スターター選択、初回イベント |
| FOREST（もりエリア） | 38×28 | 5-8 | ジム、泳ぎ探索 |
| MISTY_SWAMP（霧の湿地） | 40×30 | 7-11 | 毒沼ダメージ、泳ぎ探索 |
| CORAL_REEF（珊瑚の浜） | 38×28 | 8-13 | 泳ぎ探索、水中隠しアイテム |
| CRYSTAL_CAVE（クリスタルどうくつ） | 36×26 | 8-12 | 氷ブロック、闘技場 |
| DARK_TOWER（ダークタワー） | 32×26 | 18-24 | ダーク団イベント |
| SHADOW_GROVE（影の森） | 36×28 | 20-26 | 暗闇エリア、氷ブロック |
| VOLCANIC_PASS（マグマ峠） | 40×30 | 12-16 | ボス戦 |
| SAND_VALLEY（砂塵の谷） | 42×30 | 15-20 | 砂地エンカウント、氷ブロック |
| FROZEN_PEAK（氷峰） | 38×28 | 22-28 | ジム2、氷ブロック |
| ANCIENT_LIBRARY（古代図書館） | 34×26 | 24-30 | テレポートパッド |
| SKY_RUINS（そらの遺跡） | 42×30 | 15-20 | 最終決戦 |
| CELESTIAL_GARDEN（天空の花園） | 40×28 | 25-35 | ポストゲーム |
| STARFALL_BASIN（星降り盆地） | 44×34 | 35-45 | 四天王、最終ライバル戦 |

### 4.6 マップルート構成

```
EMOJI_TOWN → FOREST → MISTY_SWAMP → CRYSTAL_CAVE → DARK_TOWER → SHADOW_GROVE
                 ↓                          ↓
           CORAL_REEF              VOLCANIC_PASS → SAND_VALLEY → FROZEN_PEAK → ANCIENT_LIBRARY → SKY_RUINS
                                                                                                       ↓
                                                                                               CELESTIAL_GARDEN → STARFALL_BASIN
```

### 4.7 ギミック仕様

#### 毒沼（T.POISON = 8）
- 対象マップ: MISTY_SWAMP
- 歩行ごとにパーティ全員の生存モンスターに3ダメージ
- メッセージは5歩に1回表示
- 全滅時は「最後に回復した回復所」に自動帰還（HP全回復で復活）

#### テレポートパッド（T.TELEPORT = 9）
- 対象マップ: ANCIENT_LIBRARY
- ペアのパッド間を瞬時にワープ
- TELEPORT_PADSデータで座標ペアを定義

#### 氷床（T.ICE_FLOOR = 10）
- 踏むと進行方向に壁か非氷タイルまで自動的に滑る
- 滑り中はエンカウント判定なし

#### 暗闇（T.DARK = 11）
- 対象マップ: SHADOW_GROVE
- でんきタイプ不在時は画面に暗闇オーバーレイ（70%黒）
- でんきタイプがパーティにいれば自動で照らす
- 暗闇エリアから出ると自動解除

### 4.8 施設マーカー

- 主要施設（回復所・ショップ・ジム）は、ワールドマップ上で視認しやすいように施設アイコンを重ね表示する
- 主要建物は屋根付きシルエットを重ね描画し、外観で用途を判別しやすくする
- 回復NPCは通常NPCと異なる専用アイコン（回復マーク）と絵文字バッジで表示し、会話後に回復エフェクト（フラッシュ/パーティクル/回復メッセージ）を再生する
- ショップ内装は共通レイアウト（売り場通路 + カウンター）を基準とし、ジム内装は中央導線 + 対戦スペースを基準とする
- ショップNPCに話しかけた直後は「かう / うる / やめる」の選択を表示する
- ショップを開いた直後は入力ガード（短時間）を有効にし、会話開始と同フレームで「かう」へ誤遷移しないようにする
- 売却時は所持アイテム一覧から1個ずつ売却し、売値はアイテム基準価格の50%（端数切り捨て、最低1G）とする
- ショップの販売在庫は店舗（マップ）ごとに異なる
- ショップ会話中はショップウィンドウ内に現在の所持金を常時表示する
- ショップ項目数が表示上限を超える場合は、スクロールヒント（例: `↑↓でスクロール` と `▲/▼`）を表示する
- フィールド画面ではミニマップを表示せず、現在地や接続先の確認はメニューの「グローバルマップ」から行う
- メニューの「グローバルマップ」では屋内施設（研究所・ショップ・家など）を表示対象外にする
- メニューの「グローバルマップ」では未訪問エリア名を `？？？` 表示にする

---

## 5. エンカウント仕様

- 草むらタイル: 25%
- 森タイル: 12%
- 毒沼タイル: 25%（草むらと同じ判定 + 毒ダメージ）
- 砂地タイル: 8%（低確率独自判定）
- 出現候補およびレベル帯は `mapRules` でマップごとに定義
- エンカウント演出はフラッシュ + フェード

---

## 6. バトル仕様

### 6.1 コマンド

- たたかう
- いれかえ
- アイテム
- にげる

- コマンドは常に上記4つを表示する。
- 捕獲は専用コマンドではなく、`アイテム` からボール系アイテムを選択して行う。

### 6.2 行動順

1. 技優先度
2. すばやさ比較（状態補正反映）
3. 同速時ランダム

- 行動順の判定結果（例: 「〜のほうがはやい」）は戦闘メッセージとして表示しない。

### 6.2.1 逃走

- 基礎成功率: 60%
- プレイヤーのすばやさが相手より高いほど成功率上昇（速度差10ごとに±10%）
- 下限: 35%、上限: 85%
- ボス・トレーナー・闘技場からは逃走不可

### 6.3 ダメージ計算

$$
\text{Damage} = \left(\frac{2 \cdot Lv}{5} + 2\right) \cdot \frac{\text{Power} \cdot Atk \cdot AtkMult}{Def \cdot DefMult} / 50 + 2
$$

乗算補正:

- タイプ相性
- STAB
- 乱数
- ステージ補正
- 天候補正
- 特性補正

### 6.4 状態異常

- やけど
- どく
- まひ
- こおり
- ねむり

各効果量・判定率は実装コードとデータ定義を正とし、変更時は本節に追記する。

### 6.5 天候

- SUNNY / RAINY / WINDY / SNOWY / NONE
- フィールドにはゲーム内時刻（00:00〜23:59）があり、探索中に進行する
- 天候はマップごとの発生確率を基準に、ゲーム内時刻の時間帯補正を加えて毎時再抽選する
- 現在天候は同一マップ内の戦闘へ引き継ぐ
- フィールド右上に「時間帯 / 現在時刻 / 天候」を表示する
- 時間帯・天候に応じて、フィールド全体の色味オーバーレイと天候パーティクルを表示する
- 天候オーバーレイ/天候パーティクルは屋外マップでのみ表示し、屋内マップでは表示しない
- バトル中に天候が自然変化した場合、終了後のフィールド天候にも同じ結果を反映する
- ダメージ倍率へ影響

| 天候 | 強化タイプ(+30%) | 弱体化タイプ(-30%) | 備考 |
|------|-----------------|---------------------|------|
| SUNNY | FIRE | WATER, ICE | |
| RAINY | WATER, ELECTRIC | FIRE | |
| WINDY | GRASS | NORMAL(-10%) | |
| SNOWY | ICE | FIRE, GRASS | 氷峰で発生しやすい |

### 6.6 特性

- 特性マスタ: `assets/data/abilities.json`
- モンスター紐付け: `assets/data/monsters.json` の `ability`（配列）
- `ability` は `acquisitionRate` 重みで個体ごとにランダム抽選する
- `abilityId` キーは使用しない（廃止）
- 特性はダメージ計算など内部ロジックで適用するが、戦闘メッセージおよび戦闘中のモンスター情報表示には出さない。

---

## 7. 成長仕様

### 7.1 ステータス計算

```
maxHp   = baseHp + 3 × (level - 1)
attack  = baseAttack + 1 × (level - 1)
defense = baseDefense + 1 × (level - 1)
speed   = baseSpeed + floor((level - 1) / 2)
```

### 7.2 必要経験値

```
nextLevelExp = 10 + 8 × level
```

### 7.3 経験値分配

- 勝利時に先頭へ100%
- 先頭以外の生存メンバーへ30%

### 7.4 キズナ(Bond)システム

モンスターごとの成長要素として「キズナ(Bond)」パラメーターが存在します（0〜100）。
- **上昇条件**:
  - レベルアップ時に +5
  - バトル勝利時、戦闘に参加したモンスターは +2、控えの生存メンバーは +1
- **キズナの恩恵(プレイヤー側のみ)**:
  - **70以上**: 「持ちこたえる」 致死ダメージを受けた際、20%の確率でHPを1残して耐える。
  - **80以上**: 「状態異常回復」 ターン開始時、20%の確率で自身の状態異常を自然回復する（メニュー名に❤️マークが付きます）。
  - **90以上**: 「急所率アップ」 攻撃時の急所率(クリティカルヒット率)が一律 +10% される。

### 7.5 技習得・技枠

- モンスターが保持できる技は最大4枠
- レベルアップで新技を習得した際、空き枠がある場合は自動習得する
- 技枠が埋まっている場合は、習得候補ごとに「既存技と入れ替える / 覚えない」を選択する
- 既に覚えている技IDは重複習得しない

---

## 8. データ仕様（JSON）

### 8.1 共通ルール

- 既存キーを削除しない
- 型互換を壊さない
- IDは英大文字スネークケースを維持
- 同一ファイル内でID重複を禁止する（moves / monsters / items / abilities）
- モンスターの `learnset` は `{ "move": "MOVE_ID", "level": number }` 形式を正とする
- `level` は 1 以上の整数で、該当レベル到達時に技を習得する
- 旧形式（技ID文字列のみの配列）は廃止し、起動時検証で不正として扱う
- 参照整合性を必須とする（例: `learnset.move` は moves、`ability.abilityId` は abilities、`heldItems.itemId` は items、進化先/レシピ/出現プールIDは monsters に存在すること）

### 8.2 対象ファイル

- `assets/data/monsters.json`
- `assets/data/moves.json`
- `assets/data/items.json`
- `assets/data/abilities.json`

### 8.4 monsters.json 追加キー

- `secondaryType: string | null`
  - 副タイプ。単タイプの場合は `null`。
  - 被ダメージ時はタイプ相性を乗算（例: FIRE/GRASSへのWATER = 2×0.5 = 1）。
  - STABはprimaryTypeまたはsecondaryType一致で発動。
- `spawnRate: number`
  - 野生出現プール内での重み。値が大きいほど抽選されやすい。
  - 未指定時は `1` 扱い。
- `ability: [{ "abilityId": string, "acquisitionRate": number }]`
  - 個体生成時の特性抽選テーブル（必須）。
- `baseExpYield: number`
  - 撞破時に配布する経験値の基礎値（必須）。
  - 実際の獲得経験値 = `baseExpYield × (相手Lv / 5) × 場所補正 × ボーナス`。
- `heldItems: [{ "itemId": string, "dropRate": number }]`
  - モンスター所持アイテムのドロップ定義（必須、空配列可）。
  - `dropRate` は 0〜1 の確率値。
- `sizeScale: number`
  - バトル表示時の絵文字スケール倍率（必須）。
- `recipe: [[{ "monsterId": string }, { "monsterId": string }]]`
  - そのモンスターへの合成レシピ定義。
  - 2体の組み合わせは順不同で判定する。
- `evolution: { "evolvesTo": string, "condition": { "type": "LEVEL" | "ITEM", "value": number | string } } | null`
  - 進化定義。進化しないモンスターは `null`。
  - `type: "LEVEL"` の場合: `value` は進化レベル（整数）。
  - `type: "ITEM"` の場合: `value` は進化に必要なアイテムID（文字列）。

### 8.3 コンテンツ拡張（2026-03-01）

- 追加モンスター: `CINDLO` / `CINDRAKE` / `RILLY` / `RILLARGO` / `BRAMBIT` / `ARCWOLF` / `ICELARK`
- 追加技: `EMBER_SWEEP` / `RIVER_SONG` / `BRAMBLE_EDGE` / `ARC_SPIN` / `POLAR_PULSE` / `ICY_WIND`
- 追加アイテム: `MEGA_ETHER` / `RESCUE_GEL` / `DUSK_BALL`
- 出現プール（町・森・洞窟・火山・遺跡・ダークタワー・氷峰・天空の花園）とショップ在庫へ反映
- 追加モンスター（追補）: `LUMIPUP` / `SOLMANTIS` / `MISTOTTER` / `ABYSSMART` / `FERNBIT` / `GROVYRA` / `BOLTRON` / `TEMPESTEL` / `SNOWLING` / `GLAZELK`
- 追加技（追補）: `EMBER_RAIN` / `TIDE_LANCE` / `MOSS_BARRIER` / `VERDANT_BLADE` / `THUNDER_STEP` / `CRYO_LANCE` / `METEOR_BARK` / `STAR_PRAYER`
- ストーリー拡張（追補）: マップ探索中に石板・碑文イベント（`forest_tablet_1` / `cave_memory_1` / `volcano_memory_1` / `frozen_memory_1` / `ruins_memory_2` / `garden_epilogue`）を追加

### 8.4 大規模マップ・ギミック拡張（2026-03-01）

- **新マップ6エリア追加**:
  - MISTY_SWAMP（霧の湿地, 40×30）: 毒沼ギミック、泳ぎ探索
  - CORAL_REEF（珊瑚の浜, 38×28）: 水中探索、隠し真珠
  - SAND_VALLEY（砂塵の谷, 42×30）: 砂地低確率エンカウント、ライバル戦
  - SHADOW_GROVE（影の森, 36×28）: 暗闇エリア、氷ブロック、研究所跡
  - ANCIENT_LIBRARY（古代図書館, 34×26）: テレポートパッドパズル
  - STARFALL_BASIN（星降り盆地, 44×34）: 四天王4連戦、最終ライバル戦

- **新タイルタイプ5種追加**: POISON(8), TELEPORT(9), ICE_FLOOR(10), DARK(11), SAND(12)

- **新ストーリーフラグ20種追加**: 湿地・珊瑚・砂漠・影の森・図書館・四天王・最終ライバル関連

- **四天王システム**:
  - ハヤテ（Lv42）、カグラ（Lv44）、ミナモ（Lv46）、ヒョウガ（Lv48）の4連戦
  - 全員撃破で星降り盆地最奥への道が開く
  - 最奥にはライバル・レンとの最終バトル（Lv50）

- **マップルート再構成**:
  - 森→霧の湿地→洞窟（旧: 森→洞窟）
  - 火山→砂塵の谷→氷峰（旧: 火山→氷峰）
  - ダークタワー→影の森（新規分岐）
  - 氷峰→古代図書館→遺跡（旧: 氷峰→遺跡）
  - 天空の花園→星降り盆地（新規ポストゲーム）

- **新出現プール6種**: swamp/coral/sandValley/shadowGrove/library/basin

### 8.5 バランス調整（2026-03-01）

- ICEタイプ相性: ICE→WATER を 0.5→1.0（半減→等倍）、ICE→NORMAL を 1.0→1.5（等倍→効果抜群）に変更
- 天候SNOWY追加: ICE+30%、FIRE-30%、GRASS-30%。氷峰マップで45%の確率で発生
- 逃走確率: 固定60%→速度差による可変（35%〜85%）
- アイテム差別化: げきりんキャンディ→攻撃+1&速度+1、ガードチャーム→防御+1&HP15%回復
- ICE型モンスター4種に新技`ICY_WIND`を習得追加

### 8.6 全モンスターパラメータバランス調整（2026-03-01）

全74体のbaseStats・baseExpYieldをティア基準に統一調整。

- **ティアBST目標**:
  - 進化前（スターター）: ~200
  - 進化前（中盤）: ~200-210
  - 進化前（後半）: ~210-218
  - 序盤非進化: ~210-220
  - 中盤非進化: ~235-255
  - スターター進化後: ~270
  - 中盤進化後: ~275-280
  - 後半進化後: ~285-295
  - レア/ボス: ~270-280
  - 伝説（ETERNIA）: ~330
- **主要変更**:
  - LEAFLING: BST 188→200（+12）スターター均衡化
  - ICEPECK: BST 195→215（+20）序盤ICE底上げ
  - CRYSTEEL: BST 210→230（+20）中盤ICE底上げ
  - FROSTVEIL: BST 267→280（+13）進化後ICE底上げ
  - FUNGORIA: BST 270→280（+10）進化後GRASS底上げ
  - MOSSHORN: BST 263→250（-13）非進化GRASS過剰修正
  - TEMPESTEL: BST 305→295（-10）進化後ELECTRIC過剰修正
  - ARCWOLF: BST 264→255（-9）非進化ELECTRIC過剰修正
  - VOLCANOX: BST 288→280（-8）中盤進化FIRE過剰修正
  - WHALORD: BST 264→275（+11）レアWATER底上げ
  - COSMOWL: BST 262→275（+13）レアNORMAL底上げ
- **タイプ別BST平均（調整後）**: FIRE=245, WATER=244, GRASS=239, ELECTRIC=244, ICE=243, NORMAL=254
- **baseExpYield**: BSTに比例するよう全体を再調整。伝説ETERNIA: 61→65

### 8.7 全フィールド総合調整（2026-03-01）

全77体のsecondaryType / learnset / catchRate / ability / spawnRate / heldItems / sizeScale / recipe を一括調整。進化用アイテム3種を追加。

#### 複合タイプ（secondaryType）
- 31体に副タイプを付与（約40%）。進化後・レア系を中心に戦略的多様性を追加。
- 例: AQUASHELL→WATER/ICE, ZAPDRAKE→ELECTRIC/FIRE, SOLFLARE→FIRE/ELECTRIC, GLACIDRAKE→ICE/WATER, AURORO→NORMAL/ELECTRIC, RUNEFOX→NORMAL/FIRE, COSMOWL→NORMAL/ICE
- 副タイプを持つモンスターには、そのタイプの技をlearnsetに追加。

#### 技構成（learnset）
- 複合タイプモンスター: 副タイプ技を1〜2枠追加（例: SOLFLARE→THUNDERBOLT, AURORO→THUNDERBOLT, COSMOWL→ICE_BEAM, ZAPDRAKE→FIRE_FANG, GLACIDRAKE→AQUA_JET）
- レベル配分を調整: 基本技Lv1→中級Lv4-6→上級Lv8-12→最終Lv13-16

#### 捕獲率（catchRate）
- ティア相関に統一:
  - 進化前（序盤）: 0.23〜0.40
  - 非進化（中盤）: 0.14〜0.22
  - 進化後: 0.07〜0.15
  - レア/ボス: 0.05〜0.12
  - 伝説（ETERNIA）: 0.03

#### 特性（ability）
- 約35体に複数特性を付与。第1特性60〜70%、第2特性30〜40%の取得率。
- 例: PYREBEAR→BLAZE(0.7)/INTIMIDATE(0.3), AQUASHELL→TORRENT(0.5)/STURDY(0.5), ZAPDRAKE→MOTOR_DRIVE(0.5)/BLAZE(0.5)

#### 出現率（spawnRate）
- 差別化を導入:
  - 一般: 1.0〜1.2
  - やや希少: 0.7〜0.9
  - 希少: 0.4〜0.6
  - 超希少: 0.1〜0.3

#### 所持アイテム（heldItems）
- 38体にドロップアイテムを設定。ドロップ率3〜15%。
- テーマ別: 攻撃的→POWER_SEED/RAGE_CANDY, 防御的→IRON_SEED/GUARD_CHARM, 速度→X_SPEED, 回復→POTION/ETHER

#### 表示サイズ（sizeScale）
- 範囲: 0.70（SPARKBUG）〜1.40（ETERNIA）
- 進化前: 0.7〜0.85, 中間: 0.85〜1.0, 進化後: 1.1〜1.25, 大型: 1.3〜1.4

#### 合成レシピ（recipe）
- 全77体にrecipeフィールドを定義（未設定は空配列）
- 新規レシピ5件追加:
  - SOLFLARE = PYREBEAR + BLAZEBIRD
  - WHALORD = TIDALON + AQUASHELL
  - COSMOWL = MOONMITE + SKYPIP
  - SPIRALHORN = MOSSHORN + CRYSTALINE
  - GLACIDRAKE = BLIZZCAT + TUNDRABEAR
- 既存5件は維持（BRAMBLEON, GLACIERA, MISTRAY, AURORO, RUNEFOX）

#### 進化用アイテム追加
- items.jsonに3種追加:
  - FIRE_CRYSTAL（ほのおの結晶）: 1500G
  - THUNDER_CRYSTAL（いかずちの結晶）: 1500G
  - ICE_CRYSTAL（こおりの結晶）: 1500G
- 3体の進化条件をLEVEL→ITEMに変更:
  - CHARCOIL → SERPYRO（FIRE_CRYSTAL）
  - LIGHTNIX → THUNDAGLE（THUNDER_CRYSTAL）
  - SNOWFAWN → FROSTVEIL（ICE_CRYSTAL）

### 8.4 起動時検証

- `js/data/dataValidation.ts` のスキーマ検証を通過すること

---

## 9. 進行と保存

- セーブ媒体は LocalStorage
- セーブはメイン1本 + バックアップ1本を保持し、メイン破損時はバックアップから自動復旧を試行する
- 手動セーブは `P` キーまたはメニューの「セーブ」から実行できる
- セーブ対象:
  - プレイヤー状態
  - パーティ/ボックス
  - 所持品
  - 進行フラグ
  - 訪問済みマップ一覧
  - 日替わりチャレンジ状態
- 遷移時・バトル後のオートセーブは設定でON/OFFを切替できる（ON時は画面右上に「💾 セーブ中…」トースト表示）
- 実績の解除状態をセーブデータに含む
- モンスターのニックネームをセーブデータに含む
- 「最後に回復した回復所」の復帰地点をセーブデータに含む

### 9.1 設定項目

- 設定画面（タイトル/メニュー）は同一項目を表示する
- 設定で変更できる項目:
  - ミュート
  - BGM音量
  - SE音量
  - バトル速度
  - メッセージ自動送り
  - エンカウント演出短縮
  - エモスキップ ON/OFF（ON時、条件を満たした野生バトルは自動でスキップ）
  - オートセーブ ON/OFF
  - 画面の明るさ（60%〜140%）

### 9.2 ガイド仕様

- ガイドは「目次 + 詳細ページ」構成とし、1ページにつき1項目を表示する
- 目次で項目を選択して詳細を開き、詳細内では `↑` / `↓` で前後の項目へ移動できる
- ガイド内容は現行仕様（新マップ、探索ギミック、可変逃走率、セーブ導線、メニュー機能）を反映する

---

## 10. 演出仕様

### 10.1 オーディオ

- BGM: Tone.js によるプロシージャル合成（メロディ・ベース・パッドの3レイヤー構成）
- SE: FM合成・ノイズ合成・メンブレン合成を組み合わせた手続き型効果音
- エフェクトチェイン: Chorus → FeedbackDelay → Reverb → Volume
- エリアごとに固有のBGMを定義（フィールド・バトル・森・洞窟・火山・氷峰・遺跡・ダーク・タイトル）

### 10.2 グラフィックエフェクト

- Phaser PostFX Pipeline を使用（外部ライブラリ不要）
- カメラ効果: ビネット、ブルーム
- オブジェクト効果: グロー、シャイン
- パーティクル: タイプ別ヒットエフェクト、レベルアップ、進化、撃破、天候
- ダメージ演出: 画面フラッシュ + シェイク（効果抜群時は黄色フラッシュ）
- ダメージポップアップ: フローティング数字表示（クリティカル時は💥アイコン付き赤色拡大表示、回復時は緑色＋表示）
- オートセーブ表示: マップ遷移時に「💾 セーブ中…」トースト通知を右上に表示

---

## 11. 実績システム

### 11.1 概要

- 34種の実績を4カテゴリに分類: BATTLE（バトル）/ COLLECTION（収集）/ EXPLORATION（探索）/ MASTERY（やりこみ）
- 実績はバトル終了時・マップ遷移時・シーン復帰時に自動チェックされる
- 解除時はワールドマップ上にトースト通知（スライドイン/アウト）を表示
- 解除済み実績はセーブデータに永続保存される

### 11.2 メニュー表示

- メニューに「🏆 実績」項目を追加
- カテゴリ別ヘッダー付きスクロール可能リスト
- 進捗バー（解除数/総数）を上部に表示
- 未解除は「❓ ?????」、解除済みはアイコン＋名称＋説明文を表示

### 11.3 実績一覧

| カテゴリ | 数 | 例 |
|---|---|---|
| BATTLE | 10 | 初バトル勝利、25/75/100戦到達、闘技場5連勝、ジム2制覇 等 |
| COLLECTION | 9 | 初捕獲、図鑑10/30/全種、パーティ満員、全アイテム所持 等 |
| EXPLORATION | 7 | エリア訪問（3/7/12）、街ライバル勝利、ダークタワー突破、伝説撃破 等 |
| MASTERY | 8 | 所持金10万、四天王1人撃破/全員撃破、最終ライバル勝利、日替わり達成、1時間プレイ 等 |

---

## 12. ニックネームシステム

- パーティモンスターに最大12文字のニックネームを設定できる
- メニューのパーティ画面で `N` キーを押すと、ゲーム内キーボードの命名UIを表示する
- パーティ画面では選択中モンスターの詳細ステータス（能力値/EXP/わざPP）を専用の詳細パネルに表示する
- ニックネーム設定時は表示名をニックネームに置き換え、種族名の併記は行わない
- ニックネームはセーブデータに永続保存される
- 空文字を入力するとニックネームを解除できる

---

## 13. バトルAI仕様

### 13.1 通常AI

- PP残量を確認し、使用可能な技のみから選択
- 全技PP切れ時は「わるあがき」を使用
- HP25%以下で回復技を70%の確率で優先使用
- バフ技は40%の確率で選択（ランクが既に高い場合は確率低下）
- 状態異常技は相手が正常状態の場合50%の確率で選択
- タイプ相性・STAB・威力を総合したスコアリングで攻撃技を選択
- 確殺可能な技がある場合はその技を優先

### 13.2 ボスAI

- 通常AIのロジックに加え、より精密な判断を行う
- 回復技の使用閾値: HP30%以下（通常は25%）
- 回復技の使用確率: 85%（通常は70%）
- バフ技の使用確率: 55%（通常は40%）
- タイプ相性スコアリングのブレ幅が小さい（精度が高い）

---

## 14. AI実装ガイド（仕様変更時）

1. 変更分類を決める（ルール変更 / 演出変更 / 運用変更）
2. 仕様変更なら本書を更新
3. 最小差分でコード変更
4. `npm run lint` → `npm run typecheck` → `npm run test`
5. 仕様と実装の差分がないか確認

---

## 15. 変更履歴（運用ルール）

- 仕様に影響する変更を行ったら、PRまたは作業ログ内で以下を明記する。
  - 対象章
  - 変更理由
  - 互換性影響の有無

例:

```
[仕様更新] 6.4 状態異常: まひの行動不能率を 20% → 25% に変更
理由: バトルテンポと危険度のバランス調整
互換性: セーブ互換あり
```

---

## 16. UIガイドライン（全画面共通）

本章は、タイトル / ワールド / メニュー / バトル / ショップを横断して、見た目と操作の統一感を維持するための基準である。  
UIの新規追加・改修時は本章を優先し、差異が必要な場合は理由を仕様変更として明記する。

### 16.1 デザイン原則

- 原則は「暗色ベース + 暖色アクセント + 低彩度補助色」。
- 主要UIは「可読性 > 装飾」を優先し、情報の優先順位を明確にする。
- 1画面内で主役のアクセント色は1系統に限定し、競合する強色を同時使用しない。
- すべての画面で「情報パネル」「選択中」「補助情報」の見分けが一目で付くことを必須とする。

### 16.2 タイポグラフィ

- 共通フォントトークンを使用する（直書き禁止）。
  - `FONT.TITLE`: タイトルロゴ・章見出し
  - `FONT.UI`: メニュー、本文、ラベル
  - `FONT.MONO`: バージョン、数値、技術情報
  - `FONT.EMOJI`: 絵文字モンスター・絵文字エフェクト
- 本文最小サイズは 11px、通常本文は 12〜14px、見出しは 18px 以上を基準とする。
- 重要情報（現在選択・警告・報酬）は太字化で差を付け、過剰な文字サイズ差は使わない。

### 16.3 カラー/トークン運用

- 色は `COLORS` / `TEXT_COLORS` を一次情報とし、Scene側での生値（hex直書き）は原則禁止。
- 役割別の基本配色:
  - パネル背景: `COLORS.PANEL_BG` 系
  - 枠線: `COLORS.PANEL_BORDER` 系
  - 選択中: `COLORS.SELECT_BG` / `COLORS.SELECT_BORDER`
  - 主要強調: `COLORS.GOLD` / `TEXT_COLORS.ACCENT`
  - 補助情報: `TEXT_COLORS.SECONDARY`
- 成否・危険など意味を持つ色は、情報の意味を変更しない限り固定する（成功=緑、危険=赤）。

### 16.4 レイアウト/パネル

- パネルは `drawPanel()` を標準とし、独自描画は特殊演出時のみ許可。
- 選択ハイライトは `drawSelection()` を標準とし、選択状態の視覚差を統一する。
- パネル内余白の目安:
  - 外枠余白: 8〜12px
  - 行間: 4〜8px
  - セクション間: 12px以上
- 1画面内で角丸半径・枠線太さを乱立させない（同系統パネルは同値を使う）。

### 16.5 画面別適用ルール

- タイトル:
  - ロゴ（`FONT.TITLE`）とメニュー（`FONT.UI`）の階層差を明確化。
  - 背景演出は可読性を損なわない輝度で運用する。
- ワールド:
  - HUD（時間/天候/地名）は同一トークンで表示し、視認性優先で情報密度を抑える。
  - 実績トースト等の通知はパネルスタイルを共通化する。
- メニュー/ショップ:
  - リスト項目は未選択/選択/非活性の3状態を固定色で統一。
  - 金額・所持数など比較情報は桁ずれしないよう配置を揃える。
- バトル:
  - コマンド行、技一覧、詳細欄の強調色競合を避ける。
  - 絵文字表示・捕獲演出は `FONT.EMOJI` を使用し、環境差分を最小化する。

### 16.6 操作フィードバック

- すべての選択操作は「視覚（ハイライト）+ 音（SE）」の両方で反応を返す。
- キャンセル不可状態（演出中、選択確定待ちなど）は、見た目で操作不可を判別できるようにする。
- 入力競合を防ぐため、`dialog` / `choice` / `battlePending` 中は不要なUI遷移を発生させない。

### 16.7 アクセシビリティ基準

- 文字色と背景色は、暗背景で判読不能にならないコントラストを維持する。
- 情報伝達を色のみに依存しない（記号、ラベル、位置でも区別できること）。
- 点滅・フラッシュ演出は短時間に限定し、常時点滅UIは使用しない。

### 16.8 運用ルール

- UI変更時は、対象画面で以下を最低確認する。
  - 文字可読性（通常時/選択時）
  - 入力状態差（通常/選択/無効）
  - 既存トークン準拠（フォント/色/パネル）
- 新規UIコンポーネントを追加した場合は、本章へルールを追記してから展開する。
