# EMOJIMON ゲーム設計書

このドキュメントは Emojimon のゲーム仕様に関する一次情報です。  
実装変更で仕様が変わる場合は、必ず本書を先に更新してからコードへ反映します。

---

## 1. 設計方針

- 対象: ブラウザ上で短時間に遊べる 2D ターン制バトルRPG
- 体験目標:
  - 1バトルのテンポがよい
  - 進行不能が起きない
  - データ駆動で拡張しやすい
- 実装方針:
  - ルールは `js/data` を優先して集約
  - 表示は Scene と `js/ui` で分離
  - データは `assets/data/*.json` を正とする

---

## 2. ドキュメント境界

- 本書に記載するもの
  - ゲームルール、進行条件、数式、パラメータ、仕様上の制約
- 本書に記載しないもの
  - セットアップ手順、開発コマンド、運用フロー（`README.md`に記載）
  - AIの作業規約（`AGENTS.md`に記載）

---

## 3. コアゲームループ

1. ワールド探索
2. エンカウント発生
3. ターン制バトル
4. 成長（経験値・所持金・進化）
5. 次の進行条件へ挑戦

### 3.1 新規開始フロー

- タイトルの「はじめから」選択時は、フィールド表示の前にプロローグ演出を再生し、終了後は研究所（LAB）から開始する
- 研究所（LAB）に到着した直後、博士の説明イベントが自動で開始される
- スターターモンスターを選ぶまで、研究所（LAB）から町（EMOJI_TOWN）へは出られない
- 研究所のスターター台座は、モンスター絵文字ラベルのみを表示し、通常NPCアイコンは重ね表示しない
- モンスターデータでは全モンスターに `sub_emoji` フィールドを持たせる（空配列可）
- 単体表示で重ね描画を行う場合は `sub_emoji` を明示指定する（暗黙的な2グラフェム自動重ねは行わない）
- 例: `"sub_emoji": [{"emoji":"❄️","point":"top-right","size":0.5}]`
- `sub_emoji[].point` は位置キーワード（`center` / `top-right` など）または座標（`{ "x": number, "y": number }`）を許可する
- モンスター未所持の状態では、フィールド（FOREST）へ遷移できない
- プロローグ完了後に `WorldScene`（研究所/LAB）へ遷移する
- 初回ナレーション完了フラグ（`storyFlags.introNarrationDone`）はプロローグ終了時に立つ

---

## 4. フィールド仕様

### 4.1 タイルコード

| コード | 種別 | 説明 |
|---|---|---|
| 0 | 地面 | 歩行可能 |
| 1 | 壁 | 通行不可 |
| 2 | 草むら | エンカウント判定対象 |
| 3 | ドア | マップ遷移 |
| 4 | 森 | 低確率エンカウント判定対象 |
| 5 | 水 | 通行不可（装飾/ギミック対象） |
| 6 | ジム | 互換用イベントタイル（現行は主にジムNPC起点） |
| 7 | 道 | 歩行可能 |

### 4.2 基本操作

| キー | 用途 |
|---|---|
| ←↑→↓ / WASD | 移動 |
| Z / Space | 決定・会話 |
| X / ESC | メニュー / キャンセル |
| P | セーブ |

- バトル中、メッセージ表示中に `Z` / `Space`（タッチではAボタン）を長押しするとメッセージを高速送りする
- 会話表示は「話者名ウィンドウ」と「本文ウィンドウ」を分離して表示し、本文内に `話者名:` の接頭辞は表示しない
- 研究所のスターター最終確認（はい / いいえ）は、キー直指定ではなく専用の選択ウィンドウで行う
- 研究所イベントおよび初回野生バトルでは、操作ガイド文を自動表示しない

### 4.3 マップ遷移

- ドアタイル踏破で遷移演出を実行
- 遷移時にオートセーブを実行
- 主要施設（ショップ・ジム）は屋外建物のドアから屋内マップへ遷移する
- 施設NPC（店員・ジムリーダー）は原則として屋内マップに配置する

### 4.4 探索アクション

- FIRE: 特定オブジェクトを解除
- WATER: 特定水面の移動解禁
- ELECTRIC: 特定隠し要素の可視化
- 取得済みフラグはセーブデータに保持

### 4.5 施設マーカー

- 主要施設（回復所・ショップ・ジム）は、ワールドマップ上で視認しやすいように施設アイコンを重ね表示する
- 主要建物は屋根付きシルエットを重ね描画し、外観で用途を判別しやすくする
- 回復NPCは通常NPCと異なる専用アイコン（回復マーク）と絵文字バッジで表示し、会話後に回復エフェクト（フラッシュ/パーティクル/回復メッセージ）を再生する
- ショップ内装は共通レイアウト（売り場通路 + カウンター）を基準とし、ジム内装は中央導線 + 対戦スペースを基準とする
- フィールド画面ではミニマップを表示せず、現在地や接続先の確認はメニューの「グローバルマップ」から行う

---

## 5. エンカウント仕様

- 草むらタイル: 25%
- 森タイル: 12%
- 出現候補およびレベル帯は `mapRules` でマップごとに定義
- エンカウント演出はフラッシュ + フェード

---

## 6. バトル仕様

### 6.1 コマンド

- たたかう
- いれかえ
- アイテム
- にげる

- コマンドは常に上記4つを表示する。
- 捕獲は専用コマンドではなく、`アイテム` からボール系アイテムを選択して行う。

### 6.2 行動順

1. 技優先度
2. すばやさ比較（状態補正反映）
3. 同速時ランダム

- 行動順の判定結果（例: 「〜のほうがはやい」）は戦闘メッセージとして表示しない。

### 6.2.1 逃走

- 基礎成功率: 60%
- プレイヤーのすばやさが相手より高いほど成功率上昇（速度差10ごとに±10%）
- 下限: 35%、上限: 85%
- ボス・トレーナー・闘技場からは逃走不可

### 6.3 ダメージ計算

$$
\text{Damage} = \left(\frac{2 \cdot Lv}{5} + 2\right) \cdot \frac{\text{Power} \cdot Atk \cdot AtkMult}{Def \cdot DefMult} / 50 + 2
$$

乗算補正:

- タイプ相性
- STAB
- 乱数
- ステージ補正
- 天候補正
- 特性補正

### 6.4 状態異常

- やけど
- どく
- まひ
- こおり
- ねむり

各効果量・判定率は実装コードとデータ定義を正とし、変更時は本節に追記する。

### 6.5 天候

- SUNNY / RAINY / WINDY / SNOWY / NONE
- フィールドにはゲーム内時刻（00:00〜23:59）があり、探索中に進行する
- 天候はマップごとの発生確率を基準に、ゲーム内時刻の時間帯補正を加えて毎時再抽選する
- 現在天候は同一マップ内の戦闘へ引き継ぐ
- フィールド右上に「時間帯 / 現在時刻 / 天候」を表示する
- 時間帯・天候に応じて、フィールド全体の色味オーバーレイと天候パーティクルを表示する
- 天候オーバーレイ/天候パーティクルは屋外マップでのみ表示し、屋内マップでは表示しない
- ダメージ倍率へ影響

| 天候 | 強化タイプ(+30%) | 弱体化タイプ(-30%) | 備考 |
|------|-----------------|---------------------|------|
| SUNNY | FIRE | WATER, ICE | |
| RAINY | WATER, ELECTRIC | FIRE | |
| WINDY | GRASS | NORMAL(-10%) | |
| SNOWY | ICE | FIRE, GRASS | 氷峰で発生しやすい |

### 6.6 特性

- 特性マスタ: `assets/data/abilities.json`
- モンスター紐付け: `assets/data/monsters.json` の `ability`（配列）
- `ability` は `acquisitionRate` 重みで個体ごとにランダム抽選する
- `abilityId` キーは使用しない（廃止）
- 特性はダメージ計算など内部ロジックで適用するが、戦闘メッセージおよび戦闘中のモンスター情報表示には出さない。

---

## 7. 成長仕様

### 7.1 ステータス計算

```
maxHp   = baseHp + 3 × (level - 1)
attack  = baseAttack + 1 × (level - 1)
defense = baseDefense + 1 × (level - 1)
speed   = baseSpeed + floor((level - 1) / 2)
```

### 7.2 必要経験値

```
nextLevelExp = 10 + 8 × level
```

### 7.3 経験値分配

- 勝利時に先頭へ100%
- 先頭以外の生存メンバーへ30%

### 7.4 キズナ(Bond)システム

モンスターごとの成長要素として「キズナ(Bond)」パラメーターが存在します（0〜100）。
- **上昇条件**:
  - レベルアップ時に +5
  - バトル勝利時、戦闘に参加したモンスターは +2、控えの生存メンバーは +1
- **キズナの恩恵(プレイヤー側のみ)**:
  - **70以上**: 「持ちこたえる」 致死ダメージを受けた際、20%の確率でHPを1残して耐える。
  - **80以上**: 「状態異常回復」 ターン開始時、20%の確率で自身の状態異常を自然回復する（メニュー名に❤️マークが付きます）。
  - **90以上**: 「急所率アップ」 攻撃時の急所率(クリティカルヒット率)が一律 +10% される。

---

## 8. データ仕様（JSON）

### 8.1 共通ルール

- 既存キーを削除しない
- 型互換を壊さない
- IDは英大文字スネークケースを維持
- モンスターの `learnset` は `{ "move": "MOVE_ID", "level": number }` 形式を正とする
- `level` は 1 以上の整数で、該当レベル到達時に技を習得する
- 旧形式（技ID文字列のみの配列）は廃止し、起動時検証で不正として扱う

### 8.2 対象ファイル

- `assets/data/monsters.json`
- `assets/data/moves.json`
- `assets/data/items.json`
- `assets/data/abilities.json`

### 8.4 monsters.json 追加キー

- `spawnRate: number`
  - 野生出現プール内での重み。値が大きいほど抽選されやすい。
  - 未指定時は `1` 扱い。
- `ability: [{ "abilityId": string, "acquisitionRate": number }]`
  - 個体生成時の特性抽選テーブル（必須）。
- `recipe: [[{ "monsterId": string }, { "monsterId": string }]]`
  - そのモンスターへの合成レシピ定義。
  - 2体の組み合わせは順不同で判定する。

### 8.3 コンテンツ拡張（2026-03-01）

- 追加モンスター: `CINDLO` / `CINDRAKE` / `RILLY` / `RILLARGO` / `BRAMBIT` / `ARCWOLF` / `ICELARK`
- 追加技: `EMBER_SWEEP` / `RIVER_SONG` / `BRAMBLE_EDGE` / `ARC_SPIN` / `POLAR_PULSE` / `ICY_WIND`
- 追加アイテム: `MEGA_ETHER` / `RESCUE_GEL` / `DUSK_BALL`
- 出現プール（町・森・洞窟・火山・遺跡・ダークタワー・氷峰・天空の花園）とショップ在庫へ反映
- 追加モンスター（追補）: `LUMIPUP` / `SOLMANTIS` / `MISTOTTER` / `ABYSSMART` / `FERNBIT` / `GROVYRA` / `BOLTRON` / `TEMPESTEL` / `SNOWLING` / `GLAZELK`
- 追加技（追補）: `EMBER_RAIN` / `TIDE_LANCE` / `MOSS_BARRIER` / `VERDANT_BLADE` / `THUNDER_STEP` / `CRYO_LANCE` / `METEOR_BARK` / `STAR_PRAYER`
- ストーリー拡張（追補）: マップ探索中に石板・碑文イベント（`forest_tablet_1` / `cave_memory_1` / `volcano_memory_1` / `frozen_memory_1` / `ruins_memory_2` / `garden_epilogue`）を追加

### 8.5 バランス調整（2026-03-01）

- ICEタイプ相性: ICE→WATER を 0.5→1.0（半減→等倍）、ICE→NORMAL を 1.0→1.5（等倍→効果抜群）に変更
- 天候SNOWY追加: ICE+30%、FIRE-30%、GRASS-30%。氷峰マップで45%の確率で発生
- 逃走確率: 固定60%→速度差による可変（35%〜85%）
- アイテム差別化: げきりんキャンディ→攻撃+1&速度+1、ガードチャーム→防御+1&HP15%回復
- ICE型モンスター4種に新技`ICY_WIND`を習得追加

### 8.4 起動時検証

- `js/data/dataValidation.ts` のスキーマ検証を通過すること

---

## 9. 進行と保存

- セーブ媒体は LocalStorage
- セーブはメイン1本 + バックアップ1本を保持し、メイン破損時はバックアップから自動復旧を試行する
- セーブ対象:
  - プレイヤー状態
  - パーティ/ボックス
  - 所持品
  - 進行フラグ
  - 日替わりチャレンジ状態
- 遷移時・バトル後にオートセーブ

---

## 10. 演出仕様

### 10.1 オーディオ

- BGM: Tone.js によるプロシージャル合成（メロディ・ベース・パッドの3レイヤー構成）
- SE: FM合成・ノイズ合成・メンブレン合成を組み合わせた手続き型効果音
- エフェクトチェイン: Chorus → FeedbackDelay → Reverb → Volume
- エリアごとに固有のBGMを定義（フィールド・バトル・森・洞窟・火山・氷峰・遺跡・ダーク・タイトル）

### 10.2 グラフィックエフェクト

- Phaser PostFX Pipeline を使用（外部ライブラリ不要）
- カメラ効果: ビネット、ブルーム
- オブジェクト効果: グロー、シャイン
- パーティクル: タイプ別ヒットエフェクト、レベルアップ、進化、撃破、天候
- ダメージ演出: 画面フラッシュ + シェイク（効果抜群時は黄色フラッシュ）

---

## 11. AI実装ガイド（仕様変更時）

1. 変更分類を決める（ルール変更 / 演出変更 / 運用変更）
2. 仕様変更なら本書を更新
3. 最小差分でコード変更
4. `npm run lint` → `npm run typecheck` → `npm run test`
5. 仕様と実装の差分がないか確認

---

## 12. 変更履歴（運用ルール）

- 仕様に影響する変更を行ったら、PRまたは作業ログ内で以下を明記する。
  - 対象章
  - 変更理由
  - 互換性影響の有無

例:

```
[仕様更新] 6.4 状態異常: まひの行動不能率を 20% → 25% に変更
理由: バトルテンポと危険度のバランス調整
互換性: セーブ互換あり
```
