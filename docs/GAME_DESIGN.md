# EMOJIMON ゲーム設計書

このドキュメントは Emojimon のゲーム仕様に関する一次情報です。  
実装変更で仕様が変わる場合は、必ず本書を先に更新してからコードへ反映します。

---

## 1. 設計方針

- 対象: ブラウザ上で短時間に遊べる 2D ターン制バトルRPG
- 体験目標:
  - 1バトルのテンポがよい
  - 進行不能が起きない
  - データ駆動で拡張しやすい
- 実装方針:
  - ルールは `js/data` を優先して集約
  - 表示は Scene と `js/ui` で分離
  - データは `assets/data/*.json` を正とする

---

## 2. ドキュメント境界

- 本書に記載するもの
  - ゲームルール、進行条件、数式、パラメータ、仕様上の制約
- 本書に記載しないもの
  - セットアップ手順、開発コマンド、運用フロー（`README.md`に記載）
  - AIの作業規約（`AGENTS.md`に記載）

---

## 3. コアゲームループ

1. ワールド探索
2. エンカウント発生
3. ターン制バトル
4. 成長（経験値・所持金・進化）
5. 次の進行条件へ挑戦

---

## 4. フィールド仕様

### 4.1 タイルコード

| コード | 種別 | 説明 |
|---|---|---|
| 0 | 地面 | 歩行可能 |
| 1 | 壁 | 通行不可 |
| 2 | 草むら | エンカウント判定対象 |
| 3 | ドア | マップ遷移 |
| 4 | 森 | 低確率エンカウント判定対象 |
| 5 | 水 | 通行不可（装飾/ギミック対象） |
| 6 | ジム | イベント起点 |
| 7 | 道 | 歩行可能 |

### 4.2 基本操作

| キー | 用途 |
|---|---|
| ←↑→↓ / WASD | 移動 |
| Z / Space | 決定・会話 |
| X / ESC | メニュー / キャンセル |
| P | セーブ |

### 4.3 マップ遷移

- ドアタイル踏破で遷移演出を実行
- 遷移時にオートセーブを実行

### 4.4 探索アクション

- FIRE: 特定オブジェクトを解除
- WATER: 特定水面の移動解禁
- ELECTRIC: 特定隠し要素の可視化
- 取得済みフラグはセーブデータに保持

---

## 5. エンカウント仕様

- 草むらタイル: 25%
- 森タイル: 12%
- 出現候補およびレベル帯は `mapRules` でマップごとに定義
- エンカウント演出はフラッシュ + フェード

---

## 6. バトル仕様

### 6.1 コマンド

- たたかう
- アイテム
- いれかえ
- つかまえる
- にげる

### 6.2 行動順

1. 技優先度
2. すばやさ比較（状態補正反映）
3. 同速時ランダム

### 6.3 ダメージ計算

$$
\text{Damage} = \left(\frac{2 \cdot Lv}{5} + 2\right) \cdot \frac{\text{Power} \cdot Atk \cdot AtkMult}{Def \cdot DefMult} / 50 + 2
$$

乗算補正:

- タイプ相性
- STAB
- 乱数
- ステージ補正
- 天候補正
- 特性補正

### 6.4 状態異常

- やけど
- どく
- まひ
- こおり
- ねむり

各効果量・判定率は実装コードとデータ定義を正とし、変更時は本節に追記する。

### 6.5 天候

- SUNNY / RAINY / WINDY / NONE
- マップごとに発生確率を持ち、マップ入場時に1回だけ抽選
- 抽選された天候は同一マップ内の戦闘へ引き継ぐ
- ダメージ倍率へ影響

### 6.6 特性

- 特性マスタ: `assets/data/abilities.json`
- モンスター紐付け: `assets/data/monsters.json` の `abilityId`
- `abilityId` 未指定時はタイプ別デフォルトを利用

---

## 7. 成長仕様

### 7.1 ステータス計算

```
maxHp   = baseHp + 3 × (level - 1)
attack  = baseAttack + 1 × (level - 1)
defense = baseDefense + 1 × (level - 1)
speed   = baseSpeed + floor((level - 1) / 2)
```

### 7.2 必要経験値

```
nextLevelExp = 10 + 8 × level
```

### 7.3 経験値分配

- 勝利時に先頭へ100%
- 先頭以外の生存メンバーへ30%

### 7.4 キズナ(Bond)システム

モンスターごとの成長要素として「キズナ(Bond)」パラメーターが存在します（0〜100）。
- **上昇条件**:
  - レベルアップ時に +5
  - バトル勝利時、戦闘に参加したモンスターは +2、控えの生存メンバーは +1
- **キズナの恩恵(プレイヤー側のみ)**:
  - **70以上**: 「持ちこたえる」 致死ダメージを受けた際、20%の確率でHPを1残して耐える。
  - **80以上**: 「状態異常回復」 ターン開始時、20%の確率で自身の状態異常を自然回復する（メニュー名に❤️マークが付きます）。
  - **90以上**: 「急所率アップ」 攻撃時の急所率(クリティカルヒット率)が一律 +10% される。

---

## 8. データ仕様（JSON）

### 8.1 共通ルール

- 既存キーを削除しない
- 型互換を壊さない
- IDは英大文字スネークケースを維持

### 8.2 対象ファイル

- `assets/data/monsters.json`
- `assets/data/moves.json`
- `assets/data/items.json`
- `assets/data/abilities.json`

### 8.3 コンテンツ拡張（2026-03-01）

- 追加モンスター: `CINDLO` / `CINDRAKE` / `RILLY` / `RILLARGO` / `BRAMBIT` / `ARCWOLF` / `ICELARK`
- 追加技: `EMBER_SWEEP` / `RIVER_SONG` / `BRAMBLE_EDGE` / `ARC_SPIN` / `POLAR_PULSE`
- 追加アイテム: `MEGA_ETHER` / `RESCUE_GEL` / `DUSK_BALL`
- 出現プール（町・森・洞窟・火山・遺跡・ダークタワー・氷峰・天空の花園）とショップ在庫へ反映

### 8.4 起動時検証

- `js/data/dataValidation.ts` のスキーマ検証を通過すること

---

## 9. 進行と保存

- セーブ媒体は LocalStorage
- セーブ対象:
  - プレイヤー状態
  - パーティ/ボックス
  - 所持品
  - 進行フラグ
  - 日替わりチャレンジ状態
- 遷移時・バトル後にオートセーブ

---

## 10. AI実装ガイド（仕様変更時）

1. 変更分類を決める（ルール変更 / 演出変更 / 運用変更）
2. 仕様変更なら本書を更新
3. 最小差分でコード変更
4. `npm run lint` → `npm run typecheck` → `npm run test`
5. 仕様と実装の差分がないか確認

---

## 11. 変更履歴（運用ルール）

- 仕様に影響する変更を行ったら、PRまたは作業ログ内で以下を明記する。
  - 対象章
  - 変更理由
  - 互換性影響の有無

例:

```
[仕様更新] 6.4 状態異常: まひの行動不能率を 20% → 25% に変更
理由: バトルテンポと危険度のバランス調整
互換性: セーブ互換あり
```
