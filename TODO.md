# TODO — Emojimon 改善リスト

現行コードとドキュメントを横断確認し、改善点を可能な限り整理した一覧です。  
優先度は **改善点ごとに 高 / 中 / 低** の3段階で見積もっています。

---

## 優先度

- 🔴 高: 進行不能・仕様逸脱・データ不整合につながる項目
- 🟡 中: 体験品質・保守性・テスト性を引き上げる項目
- 🟢 低: 長期運用で効く最適化・運用改善項目

---

## A. 重大バグ・進行リスク

- [ ] **🔴A-11** セーブ直後クラッシュ時の整合性保証（メイン/バックアップの原子的切替）
- [ ] **🔴A-12** バトル遷移中の二重シーン遷移ガード（多重起動防止）
- [ ] **🟡A-13** 初回ロード時のデータ読込失敗リトライと復旧導線
- [ ] **🔴A-14** マップ遷移失敗時に移動不能化しないフェイルセーフ
- [ ] **🔴A-15** 進化演出中の入力競合（決定/キャンセル多重入力）防止
- [ ] **🟡A-16** シーン復帰時のBGM二重再生検出と抑止
- [ ] **🔴A-17** 低FPS時のターン進行多重実行（タイマー重複）防止
- [ ] **🔴A-18** 実績報酬付与をトランザクション化し中断時の重複/欠損を防止
- [ ] **🔴A-19** `initMovesFromJson`で`targetDefenseStage`がマッピングされず防御ダウン技が実質無効化
- [ ] **🔴A-20** `grantHeldItemDrops`で`dropRate`未定義時に`Math.random() > undefined`が常にfalseとなり意図しないドロップ発生
- [ ] **🔴A-21** `tickWeather`がマップテーマを無視してランダム天候を生成（火山でSNOWY等が発生しうる）
- [ ] **🟡A-22** `getMonsterMaxStamina()`の引数が未使用で将来スタミナ拡張時のバグ源
- [ ] **🟡A-23** `settingsView`のキーハンドラがビュー切替時にリークし設定画面外で入力消費
- [ ] **🟡A-24** `titleNameInput`の隠し`<input>`DOM要素がシーン破棄時に未クリーンアップ

---

## B. データ・型定義の乖離

- [ ] **🟡B-11** JSON定義から型の自動生成フロー整備（手動同期コスト削減）
- [ ] **🔴B-12** `assets/data/*.json` と `types/game.d.ts` の差分検知をCI化
- [ ] **🔴B-13** `moves/items/abilities/monsters` の相互参照整合チェックを強化
- [ ] **🟡B-14** `storyFlags` キーを列挙定数化し文字列タイポを防止
- [ ] **🟡B-15** セーブデータのバージョン・マイグレーション定義を明文化
- [ ] **🔴B-16** パラメータ範囲（最小/最大）の宣言とバリデーションを統一
- [ ] **🟢B-17** 将来ローカライズ向けに表示文言キー化の下地を作成
- [ ] **🟡B-18** データ編集者向けのJSON編集ガイドと検証手順を標準化
- [ ] **🔴B-19** `InventoryItem`型定義(`id,count`)と実装(`itemId,quantity`)のプロパティ名が完全不一致（`noCheck: true`で検出されず）
- [ ] **🔴B-20** `Item`型定義がフラット構造だが実データは`effect: {type, amount}`のネスト構造で乖離
- [ ] **🟡B-21** `moveSchema`に`targetDefenseStage`が含まれずバリデーション対象外
- [ ] **🟡B-22** `MonsterInstance`の`speedStage`がoptionalで生成時に初期化されず`|| 0`フォールバック依存
- [ ] **🟡B-23** `typeBadgeColors`が6タイプのみ定義でタイプ色定義の一元管理が不足
- [ ] **🟡B-24** `truncateLabel`で入力値0のとき`0 || ""`で空文字にフォールバック
- [ ] **🔴B-25** `game.d.ts` の `Move` 型定義(`staminaCost`)と `moves.json` の `pp` プロパティの名称不一致解消による参照エラーの防止
- [ ] **🔴B-26** `game.d.ts` の `Item` 型定義に `battleUsable` プロパティおよび `effect: { type, amount }` が存在しない構造的乖離の問題解消
- [ ] **🔴B-27** `MonsterSpecies` 型定義(`subEmoji`等)とJSONデータ(`sub_emoji`等)のプロパティ名/必須性の不一致解消と型安全性の確保
- [ ] **🔴B-28** `worldMapData.ts` の毒沼ダメージ仕様に関するコメント（先頭のみ）と実際の実装・設計書（全員）の乖離修正

---

## C. 未実装・機能不足

- [ ] **🟡C-01** バッグ一覧のスクロール/ページング強化（大量所持時の視認性）
- [ ] **🟡C-02** ボックスのソート・フィルタ（タイプ/レベル/捕獲順）
- [ ] **🔴C-03** バトル外でのPP回復アイテムに技選択UIを追加
- [ ] **🟡C-04** 訪問済みマップ間のファストトラベル導線
- [ ] **🟡C-05** 図鑑の検索（名前前方一致/タイプ絞り込み）
- [ ] **🟢C-07** 合成可能レシピのヒント表示（完全ネタバレなし）
- [ ] **🟡C-08** NPC再戦機能（経験値周回の選択肢を追加）
- [ ] **🟢C-10** 日替わりチャレンジの種類拡張（現状3種）
- [ ] **🟡C-11** クエストの追跡ピン機能（1件を常時HUD表示）
- [ ] **🟡C-12** 次目的地の案内マーカー（任意ON/OFF）
- [ ] **🟢C-13** バトルログ履歴ビュー（直近ターン確認）
- [ ] **🟡C-14** ボックスの一括移動（複数選択）
- [ ] **🔴C-15** セーブスロット複数管理（手動退避/復元）
- [ ] **🟡C-16** 実績画面のフィルタ（未達成/達成/報酬受取済み）
- [ ] **🟢C-17** バッグの自動整頓（種類・価格・使用頻度順）
- [ ] **🔴C-18** ショートカット設定（よく使うアイテム/コマンド登録）
- [ ] **🟡C-19** チュートリアル再閲覧メニュー（用語・操作再確認）
- [ ] **🟢C-20** ショップ在庫のお気に入り登録・再購入導線
- [ ] **🔴C-21** `trainerView`に氷峰ジムバッジ・四天王進捗・ポストゲームフラグが未表示（森ジムのみ）
- [ ] **🟡C-22** バトルHUDで相手のステージ変化（攻撃/防御）が非表示（自分側のみ）
- [ ] **🟡C-23** 図鑑のわざ表示が最大6件で固定`slice(0,6)`され7件以上の全わざが確認不可
- [ ] **🟢C-24** タイトル操作説明にメニュー操作・長押し・タッチ操作の説明なし
- [ ] **🟢C-25** `areaBgm`で`DARK_TOWER`キーにBGMマッピングなし（`DARK_TOWER_INNER`のみ）

---

## D. コード構造・保守性

- [ ] **🔴D-01** `WorldScene.ts`（約3093行）の責務分割を継続
- [ ] **🟡D-02** `worldMapData.ts`（約1872行）をデータ外出し（JSON分割）
- [ ] **🔴D-03** `BattleScene.ts`（約1342行）をさらに委譲化（入力/演出/遷移）
- [ ] **🔴D-04** `gameState.ts`（約907行）を保存・統計・実績・時刻で分割
- [ ] **🟡D-05** `MenuScene.ts`（約751行）をビュー制御と入力制御で分離
- [ ] **🟡D-06** `worldTrainerArena.ts`（約682行）を進行状態機械化
- [ ] **🔴D-08** 入力登録/解除を共通ユーティリティ化し、`removeAllListeners` 依存を減らす
- [ ] **🟡D-09** 文字列ID（マップ/ストーリーフラグ）を定数モジュールへ集約
- [ ] **🟢D-10** 会話テキストのデータ駆動化（翻訳/差し替え容易化）
- [ ] **🟡D-11** `any`/暗黙型推論依存箇所の削減と型注釈追加
- [ ] **🟡D-12** UI座標・余白・サイズのハードコード値を共通トークンへ統合
- [ ] **🔴D-13** `WorldScene` のイベント分岐をテーブル駆動化し分岐爆発を抑制
- [ ] **🟡D-14** `BattleScene` のステート遷移責務をUI/進行/演出で明確分離
- [ ] **🟡D-15** マップキー・遷移先・テーマ解決の定義を単一モジュールへ集約
- [ ] **🟡D-16** `UIHelper.ts` を描画プリミティブ単位で分割
- [ ] **🔴D-17** セーブのシリアライズ/デシリアライズを純粋関数として独立
- [ ] **🟢D-18** Scene間の直接参照を削減し、イベント/サービス境界を整理
- [ ] **🟡D-19** 画面別のUI定数ファイル分割（Title/Menu/Battle/World）
- [ ] **🔴D-20** 循環依存検出を導入し、構造劣化を早期検知
- [ ] **🔴D-21** `tsconfig.json`の`noCheck: true`で型チェックが完全無効（B-19/B-20の根本原因）
- [ ] **🟡D-22** `BootScene.ts`のテクスチャ生成が600行超の手続き的描画コマンド列（JSON/設定駆動化）
- [ ] **🟡D-23** `initMovesFromJson`のホワイトリスト式マッピングで漏れ発生しやすい構造（スプレッド/スキーマ駆動化）
- [ ] **🟡D-24** `partyView`/`boxView`/`bagView`の`typeColors`定義が各ファイルで重複（共通定数集約）
- [ ] **🟡D-25** `showBagMessage`/`showBoxMessage`/`showPartyMessage`が同一ロジック3箇所に重複
- [ ] **🟡D-26** `questView`のクエスト定義約200行がレンダリング関数内にインライン定義（データ分離）
- [ ] **🟡D-27** `battleHudUpdate.updateHud`のプレイヤー/相手HUD処理がほぼ同一ロジックの二重記述
- [ ] **🟢D-28** `items.ts`が極薄でアイテム効果ロジックがScene側に分散（効果適用集約でテスト容易化）

---

## E. テスト強化

- [ ] **🟡E-04** 実績判定テスト（命名と条件の整合性を含む）
- [ ] **🟡E-05** ワイルド出現プールテスト（全マップ）
- [ ] **🔴E-07** 入力共通仕様テスト（決定/キャンセル/長押し）
- [ ] **🔴E-08** 入力ロック中の競合操作テスト（dialog/choice/battlePending）
- [ ] **🔴E-09** 伝説・ジム・四天王など主要進行フラグのE2E相当テスト
- [ ] **🟡E-10** `dataValidation` への新規プール検証テスト追加
- [ ] **🟡E-11** `AudioManager` のマップキー解決テスト
- [ ] **🟢E-12** `vitest --coverage` 導入としきい値定義
- [ ] **🔴E-13** マップ遷移の回帰テスト（屋内/屋外/復帰座標）
- [ ] **🟡E-14** メニュー主要ビューの描画スモークテスト
- [ ] **🔴E-15** セーブ/ロードのプロパティベーステスト（ランダム状態）
- [ ] **🟡E-16** `dataValidation` へのファジング入力テスト
- [ ] **🟡E-17** 行動順計算（優先度/素早さ/同速）の網羅テスト
- [ ] **🔴E-18** クエスト解放条件の段階遷移テスト
- [ ] **🟡E-19** ショップ売買フロー（購入/売却/在庫切れ）テスト
- [ ] **🟢E-20** タッチ操作の長押し/誤タップ耐性テスト
- [ ] **🔴E-21** `initMovesFromJson`の全プロパティマッピング（特に`targetDefenseStage`）検証テスト
- [ ] **🔴E-22** `battleResultRewards`の経験値計算・分配・所持金計算・ドロップ判定が完全未テスト
- [ ] **🟡E-23** `InventoryItem`の追加・削除・重複統合の単体テスト未実装
- [ ] **🟡E-24** `battleMessageFlow`のメッセージキュー・速度倍率・自動送りディレイ計算が未テスト
- [ ] **🟡E-25** `battleHudUpdate.truncateLabel`等の純粋関数が未テスト
- [ ] **🟡E-26** `areaBgm.test.ts`で`DARK_TOWER`/`MISTY_SWAMP`/`SAND_VALLEY`等の多数マップキーが未検証
- [ ] **🟡E-27** `battleCalcStatus.test.ts`でタイプ相性倍率・特殊技カテゴリ・防御ステージ補正が未検証
- [ ] **🟡E-28** `evolution.test.ts`でBOND条件進化・`evolveMonster`・`syncMonsterMoves`が未テスト
- [ ] **🟡E-29** 天候遷移ロジック（`tickWeather`）の純粋関数抽出とテスト追加
- [ ] **🟢E-30** 名前入力バリデーション（空白のみ・制御文字・最大長）の未テスト
- [ ] **🟢E-31** ボックス操作（追加・パーティ交換・上限超過）のテスト欠落
- [ ] **🟢E-32** アイテム使用効果（HP回復量・状態異常治癒・捕獲率補正の適用）のテスト欠落
- [ ] **🟡E-33** 共通UI制御 (`UIHelper.ts` / `TouchControls.ts`) や初期化 (`BootScene.ts`) のユニットテスト/結合テスト追加

---

## F. UX・操作性改善

- [ ] **🟡F-02** バトル技選択でPP低下時の警告色/警告記号
- [ ] **🟡F-03** リザルト画面の内訳表示（経験値/所持金/実績進捗）
- [ ] **🟡F-04** 図鑑で未訪問/既捕獲/未捕獲の切替表示
- [ ] **🔴F-05** パーティ画面の長文折返し・情報パネル崩れ対策
- [ ] **🟢F-06** 合成導線をメニュー内で明示（どこで確認できるか）
- [ ] **🟢F-07** 隠し探索ポイントに弱い視覚ヒントを追加
- [ ] **🟡F-08** 長押し操作のチュートリアル再確認導線
- [ ] **🔴F-09** タッチ端末向けヒットエリアと誤タップ許容の再調整
- [ ] **🟡F-10** フィールド→メニュー→フィールド遷移時のフォーカス位置保持
- [ ] **🟡F-11** 設定画面で変更反映プレビューを即時表示
- [ ] **🟡F-12** 既読会話スキップの粒度設定（通常/重要会話除外）
- [ ] **🟢F-13** マップ遷移時のロード感軽減演出（簡易トランジション統一）
- [ ] **🟢F-14** ガイド文言の用語統一（会話/説明で表現差をなくす）
- [ ] **🟡F-15** 戦闘コマンド説明の簡易ツールチップ表示
- [ ] **🟢F-16** 設定項目の検索/ジャンプ（項目数増加に備える）
- [ ] **🔴F-17** 色覚多様性に配慮した識別補助（色+記号の二重化）
- [ ] **🟡F-18** 文字サイズプリセット（小/中/大）
- [ ] **🟡F-19** サウンド設定の詳細化（BGM/SE/通知音の個別調整）
- [ ] **🟢F-20** 再訪プレイヤー向けの短い再案内カード
- [ ] **🟡F-21** メニュー再オープン時の前回タブ記憶
- [ ] **🔴F-22** 名前入力UIのIME変換中誤確定をさらに抑止
- [ ] **🟡F-23** `achievementsView`のスクロール計算でheaderHeight/itemHeight差異による選択位置ズレ
- [ ] **🟡F-24** `boxView`/`pokedexView`/`globalMapView`にスクロールインジケータ（現在位置/全体量）なし
- [ ] **🟡F-25** `partyView`の技表示Y座標が固定値でステータス行数によりパネル外にはみ出すリスク
- [ ] **🟢F-26** `questView`がスクロール専用UIで個別クエスト詳細展開やピン留め導線なし
- [ ] **🟢F-27** `bagView`のアイテム説明テキスト配置がリスト末尾と重なるリスク
- [ ] **🟢F-28** `index.html`にOpen Graphメタタグ未設定（SNS共有時にプレビューなし）
- [ ] **🟢F-29** `WorldScene` の毒沼（POISON_SWAMP）ダメージ時に、一部モンスターのみがひんしになった際の個別通知（全滅時以外の反馈）追加

---

## G. パフォーマンス最適化

- [ ] **🟢G-01** `encounterCooldown` 更新処理の集約
- [ ] **🟡G-02** NPC描画の差分更新（全破棄・再生成の削減）
- [ ] **🟡G-03** マップデータの遅延ロード/分割ロード
- [ ] **🔴G-04** セーブ時フルシリアライズ負荷の緩和（差分保存または頻度制御）
- [ ] **🟢G-05** 図鑑の検索ループを `Set`/キャッシュで最適化
- [ ] **🟡G-06** バトルHUD再描画を変更検知ベースへ
- [ ] **🟢G-07** 重いUI構築処理の再利用（プーリング）
- [ ] **🟢G-08** 長時間プレイ時のメモリ増加監視（パーティクル/タイマー）
- [ ] **🟡G-09** マップ定義アクセスのキャッシュ化（再計算削減）
- [ ] **🟢G-10** パーティクル量の動的調整（端末性能に応じて可変）
- [ ] **🟡G-11** AudioNode再利用で初期化コストを削減
- [ ] **🔴G-12** タイル衝突判定のホットパス最適化
- [ ] **🟡G-13** オートセーブのデバウンス制御でI/O負荷を平準化
- [ ] **🟢G-14** 頻用UIアセットの先読み/プリウォーム
- [ ] **🟡G-15** 天候パーティクルが固定33msタイマーでフレームレートと非同期（ちらつき/カクつきリスク）
- [ ] **🟢G-16** `globalMapView`で毎レンダリング時にエッジ重複チェック用`Set`を再生成しフル走査

---

## H. 堅牢性・障害解析

- [ ] **🟡H-01** `Tone.js` 例外時の診断ログを標準化（握りつぶし削減）
- [ ] **🔴H-02** セーブ書き込み失敗時のユーザー通知を明確化
- [ ] **🟡H-03** 破損セーブ復旧時の理由表示（主/副どちらを採用したか）
- [ ] **🔴H-04** 入力名（プレイヤー/ニックネーム）の禁止文字・制御文字フィルタ
- [ ] **🔴H-05** `localStorage` 容量上限到達時のフェイルセーフ
- [ ] **🔴H-06** ボックス上限/在庫上限の境界チェック強化
- [ ] **🟢H-07** プラグイン未ロード時のフォールバックUI確認
- [ ] **🔴H-08** 例外時にシーン遷移不能にならない共通エラーハンドラ
- [ ] **🟡H-09** 障害ログに相関IDを付与し原因追跡を容易化
- [ ] **🔴H-10** セーブデータ整合性チェック（チェックサム/署名）導入
- [ ] **🟡H-11** `AudioContext` 停止状態からの自動復旧導線
- [ ] **🟢H-12** キー押下スタック異常（押しっぱなし化）の自己回復
- [ ] **🔴H-13** テレポート/ドア定義の片方向欠落検出
- [ ] **🟡H-14** 設定データのバージョン差異吸収（安全な既定値適用）
- [ ] **🟡H-15** 空`catch`ブロック24箇所（FXHelper/AudioManager/gameState等）の診断ログ付き改善
- [ ] **🟡H-16** ジムクリア分岐が`gymNumber === 2`のハードコードで3つ目以降のジム追加時に対応漏れ
- [ ] **🟡H-17** `showNextMessage`のキュー消化後遷移が3パターンのみで他ステートにフォールスルー
- [ ] **🟢H-18** CDNスクリプト（`phaser.min.js`）にSRI（`integrity`）ハッシュ未設定
- [ ] **🟢H-19** `index.html`に`Content-Security-Policy`メタタグ未設定（XSS耐性基盤欠如）
- [ ] **🟢H-20** `<noscript>`フォールバック未設定（JS無効時に白画面）
- [ ] **🟢H-21** `__APP_VERSION__`グローバル変数のVite以外ビルド環境での無防備参照
- [ ] **🔴H-22** `Phaser` 型定義 (`@types/phaser` または同様の型パッケージ) の不足による800件以上の型エラー解消（`D-21` と併せて対応必須）

---

## I. バランス・コンテンツ拡張

- [ ] **🟢I-01** タイプ別の技・モンスター偏り分析（特にICE/NORMAL）
- [ ] **🟡I-02** 中盤〜終盤のレベル帯ギャップ再調整
- [ ] **🟢I-03** 天候連動技・特性の拡張（天候システム活用）
- [ ] **🟡I-04** ボス専用ギミック（行動パターン/専用演出）
- [ ] **🟢I-05** 図鑑達成報酬・段階報酬の導入
- [ ] **🟢I-06** サブクエスト報酬の魅力度再調整
- [ ] **🟡I-07** 闘技場の報酬/難易度カーブを段階化
- [ ] **🟢I-08** 周回プレイ向けの短期目標（デイリー/ウィークリー）
- [ ] **🟡I-09** 技威力・命中率の外れ値検出と再調整
- [ ] **🟢I-10** 状態異常の期待値シミュレーション（強弱の数値確認）
- [ ] **🟡I-11** レベル帯ごとの捕獲率カーブ再設計
- [ ] **🔴I-12** 所持金の流入/流出バランス（インフレ抑制）調整
- [ ] **🟢I-13** トレーナー手持ち構成の多様化（同質編成の削減）
- [ ] **🟡I-14** 実績報酬の段階設計（序盤過剰/終盤不足の是正）

---

## J. 開発体験・運用

- [ ] **🔴J-01** CIで `lint -> typecheck -> test -> build` を逐次実行
- [ ] **🟡J-02** PR時のテスト結果・カバレッジ可視化
- [ ] **🟢J-03** 主要モジュールのアーキテクチャ図（Scene/Data/State）
- [ ] **🟢J-04** デバッグ用チートコマンド（開発ビルド限定）
- [ ] **🟢J-05** バランス調整支援スクリプト（出現率/勝率試算）
- [ ] **🟡J-06** 変更時チェックリストのテンプレート化
- [ ] **🟡J-07** `TODO.md` の「着手中 / 保留 / 完了」運用ルール明記
- [ ] **🔴J-08** pre-commit / pre-push フックで最低限検証を自動化
- [ ] **🟡J-09** パフォーマンス計測スクリプト（FPS/メモリ）の定例化
- [ ] **🟢J-10** テストデータ生成スクリプト（モンスター/アイテム）整備
- [ ] **🔴J-11** リリースチェック（版数/CHANGELOG/タグ）自動検証
- [ ] **🟡J-12** テスト所要時間の可視化（遅いテスト検知）
- [ ] **🟡J-13** 未使用コード/未到達分岐の定期検出
- [ ] **🟡J-14** ビルドツールbeta版(`vite@8.0.0-beta`)・型チェッカーpreview版の安定版アップデート方針策定
- [ ] **🟢J-15** ソースコード内にTODO/FIXMEコメントが0件（局所的技術的負債のインラインコメント運用推奨）

---

## K. ドキュメント同期タスク

- [ ] **🟡K-06** セーブデータ仕様（キー/型/既定値/復旧ポリシー）を表形式で追記
- [ ] **🟡K-07** 実績一覧に「条件/ヒント/報酬」の対応表を追加
- [ ] **🟢K-08** ショップ在庫の地域差分表を `GAME_DESIGN.md` に追加
- [ ] **🔴K-09** クエスト解放条件と依存関係（連鎖/排他）を図示
- [ ] **🔴K-10** バトル状態遷移（`xstate`）の状態図を設計書へ同期
- [ ] **🟡K-11** オーディオ初期化/再生キュー仕様を明文化
- [ ] **🟡K-12** UIレイアウトトークン一覧（余白/文字サイズ/行高）を整備
- [ ] **🟡K-13** テスト方針（単体/統合/手動確認範囲）を設計書へ追記
- [ ] **🔴K-14** 例外時ユーザー通知と復帰手順（エラーコード）を運用文書化

---

## 統計サマリー

| カテゴリ | 🔴高 | 🟡中 | 🟢低 |
|---|---:|---:|---:|
| A. 重大バグ・進行リスク | 9 | 5 | 0 |
| B. データ・型定義の乖離 | 9 | 8 | 1 |
| C. 未実装・機能不足 | 4 | 12 | 7 |
| D. コード構造・保守性 | 8 | 16 | 3 |
| E. テスト強化 | 8 | 17 | 5 |
| F. UX・操作性改善 | 4 | 14 | 10 |
| G. パフォーマンス最適化 | 2 | 7 | 7 |
| H. 堅牢性・障害解析 | 8 | 8 | 6 |
| I. バランス・コンテンツ拡張 | 1 | 6 | 7 |
| J. 開発体験・運用 | 3 | 7 | 5 |
| K. ドキュメント同期タスク | 3 | 5 | 1 |
| **合計** | **59** | **105** | **52** |
