# TODO — Emojimon 改善リスト

現行コードとドキュメントを横断確認し、改善点を可能な限り整理した一覧です。  
優先度は **改善点ごとに 高 / 中 / 低** の3段階で見積もっています。

---

## 優先度

- 🔴 高: 進行不能・仕様逸脱・データ不整合につながる項目
- 🟡 中: 体験品質・保守性・テスト性を引き上げる項目
- 🟢 低: 長期運用で効く最適化・運用改善項目

---

## A. 重大バグ・進行リスク

- （対応済み）

---

## B. データ・型定義の乖離

- （対応済み）

---

## C. 未実装・機能不足

- [ ] **🟡C-01** バッグ一覧のスクロール/ページング強化（大量所持時の視認性）
- [ ] **🟡C-02** ボックスのソート・フィルタ（タイプ/レベル/捕獲順）
- [ ] **🔴C-03** バトル外でのPP回復アイテムに技選択UIを追加
- [ ] **🟡C-04** 訪問済みマップ間のファストトラベル導線
- [ ] **🟡C-05** 図鑑の検索（名前前方一致/タイプ絞り込み）
- [ ] **🟡C-06** 相性表をゲーム内ガイドとして参照可能にする
- [ ] **🟢C-07** 合成可能レシピのヒント表示（完全ネタバレなし）
- [ ] **🟡C-08** NPC再戦機能（経験値周回の選択肢を追加）
- [ ] **🟡C-09** ポストゲーム導線（四天王後の短期目標）をメニューに明示
- [ ] **🟢C-10** 日替わりチャレンジの種類拡張（現状3種）

---

## D. コード構造・保守性

- [ ] **🔴D-01** `WorldScene.ts`（約3093行）の責務分割を継続
- [ ] **🟡D-02** `worldMapData.ts`（約1872行）をデータ外出し（JSON分割）
- [ ] **🔴D-03** `BattleScene.ts`（約1342行）をさらに委譲化（入力/演出/遷移）
- [ ] **🔴D-04** `gameState.ts`（約907行）を保存・統計・実績・時刻で分割
- [ ] **🟡D-05** `MenuScene.ts`（約751行）をビュー制御と入力制御で分離
- [ ] **🟡D-06** `worldTrainerArena.ts`（約682行）を進行状態機械化
- [ ] **🟡D-07** 重み抽選ロジック（`pickByWeight` 相当）の共通化
- [ ] **🔴D-08** 入力登録/解除を共通ユーティリティ化し、`removeAllListeners` 依存を減らす
- [ ] **🟡D-09** 文字列ID（マップ/ストーリーフラグ）を定数モジュールへ集約
- [ ] **🟢D-10** 会話テキストのデータ駆動化（翻訳/差し替え容易化）
- [ ] **🟡D-11** `any`/暗黙型推論依存箇所の削減と型注釈追加
- [ ] **🟡D-12** UI座標・余白・サイズのハードコード値を共通トークンへ統合

---

## E. テスト強化

- [ ] **🟡E-04** 実績判定テスト（命名と条件の整合性を含む）
- [ ] **🟡E-05** ワイルド出現プールテスト（全マップ）
- [ ] **🔴E-06** セーブ互換テスト（旧データ→現行データ復元）
- [ ] **🔴E-07** 入力共通仕様テスト（決定/キャンセル/長押し）
- [ ] **🔴E-08** 入力ロック中の競合操作テスト（dialog/choice/battlePending）
- [ ] **🔴E-09** 伝説・ジム・四天王など主要進行フラグのE2E相当テスト
- [ ] **🟡E-10** `dataValidation` への新規プール検証テスト追加
- [ ] **🟡E-11** `AudioManager` のマップキー解決テスト
- [ ] **🟢E-12** `vitest --coverage` 導入としきい値定義

---

## F. UX・操作性改善

- [ ] **🟡F-02** バトル技選択でPP低下時の警告色/警告記号
- [ ] **🟡F-03** リザルト画面の内訳表示（経験値/所持金/実績進捗）
- [ ] **🟡F-04** 図鑑で未訪問/既捕獲/未捕獲の切替表示
- [ ] **🔴F-05** パーティ画面の長文折返し・情報パネル崩れ対策
- [ ] **🟢F-06** 合成導線をメニュー内で明示（どこで確認できるか）
- [ ] **🟢F-07** 隠し探索ポイントに弱い視覚ヒントを追加
- [ ] **🟡F-08** 長押し操作のチュートリアル再確認導線
- [ ] **🔴F-09** タッチ端末向けヒットエリアと誤タップ許容の再調整
- [ ] **🟡F-10** フィールド→メニュー→フィールド遷移時のフォーカス位置保持
- [ ] **🟡F-11** 設定画面で変更反映プレビューを即時表示
- [ ] **🟡F-12** 既読会話スキップの粒度設定（通常/重要会話除外）
- [ ] **🟢F-13** マップ遷移時のロード感軽減演出（簡易トランジション統一）
- [ ] **🟢F-14** ガイド文言の用語統一（会話/説明で表現差をなくす）

---

## G. パフォーマンス最適化

- [ ] **🟢G-01** `encounterCooldown` 更新処理の集約
- [ ] **🟡G-02** NPC描画の差分更新（全破棄・再生成の削減）
- [ ] **🟡G-03** マップデータの遅延ロード/分割ロード
- [ ] **🔴G-04** セーブ時フルシリアライズ負荷の緩和（差分保存または頻度制御）
- [ ] **🟢G-05** 図鑑の検索ループを `Set`/キャッシュで最適化
- [ ] **🟡G-06** バトルHUD再描画を変更検知ベースへ
- [ ] **🟢G-07** 重いUI構築処理の再利用（プーリング）
- [ ] **🟢G-08** 長時間プレイ時のメモリ増加監視（パーティクル/タイマー）

---

## H. 堅牢性・障害解析

- [ ] **🟡H-01** `Tone.js` 例外時の診断ログを標準化（握りつぶし削減）
- [ ] **🔴H-02** セーブ書き込み失敗時のユーザー通知を明確化
- [ ] **🟡H-03** 破損セーブ復旧時の理由表示（主/副どちらを採用したか）
- [ ] **🔴H-04** 入力名（プレイヤー/ニックネーム）の禁止文字・制御文字フィルタ
- [ ] **🔴H-05** `localStorage` 容量上限到達時のフェイルセーフ
- [ ] **🔴H-06** ボックス上限/在庫上限の境界チェック強化
- [ ] **🟢H-07** プラグイン未ロード時のフォールバックUI確認
- [ ] **🔴H-08** 例外時にシーン遷移不能にならない共通エラーハンドラ

---

## I. バランス・コンテンツ拡張

- [ ] **🟢I-01** タイプ別の技・モンスター偏り分析（特にICE/NORMAL）
- [ ] **🟡I-02** 中盤〜終盤のレベル帯ギャップ再調整
- [ ] **🟢I-03** 天候連動技・特性の拡張（天候システム活用）
- [ ] **🟡I-04** ボス専用ギミック（行動パターン/専用演出）
- [ ] **🟢I-05** 図鑑達成報酬・段階報酬の導入
- [ ] **🟢I-06** サブクエスト報酬の魅力度再調整
- [ ] **🟡I-07** 闘技場の報酬/難易度カーブを段階化
- [ ] **🟢I-08** 周回プレイ向けの短期目標（デイリー/ウィークリー）

---

## J. 開発体験・運用

- [ ] **🔴J-01** CIで `lint -> typecheck -> test -> build` を逐次実行
- [ ] **🟡J-02** PR時のテスト結果・カバレッジ可視化
- [ ] **🟢J-03** 主要モジュールのアーキテクチャ図（Scene/Data/State）
- [ ] **🟢J-04** デバッグ用チートコマンド（開発ビルド限定）
- [ ] **🟢J-05** バランス調整支援スクリプト（出現率/勝率試算）
- [ ] **🟡J-06** 変更時チェックリストのテンプレート化
- [ ] **🟡J-07** `TODO.md` の「着手中 / 保留 / 完了」運用ルール明記

---

## K. ドキュメント同期タスク

- [ ] **🟡K-01** `GAME_DESIGN.md` の操作キー表を現行仕様に同期（決定: `Z / Enter / Space`）
- [ ] **🟡K-02** BGMルーティング仕様を `GAME_DESIGN.md` に明記（マップキーと対応表）
- [ ] **🟡K-03** 実績命名規則（連勝/累計）を設計書に追記
- [ ] **🔴K-04** 進行フラグ更新タイミング（勝利時/会話時）を設計書に明文化
- [ ] **🔴K-05** 入力ロック仕様（dialog/choice/battlePending）の保証範囲を設計書へ追記

---

## 統計サマリー

| カテゴリ | 🔴高 | 🟡中 | 🟢低 |
|---|---:|---:|---:|
| A. 重大バグ・進行リスク | 0 | 0 | 0 |
| B. データ・型定義の乖離 | 0 | 0 | 0 |
| C. 未実装・機能不足 | 1 | 7 | 2 |
| D. コード構造・保守性 | 4 | 7 | 1 |
| E. テスト強化 | 4 | 4 | 1 |
| F. UX・操作性改善 | 2 | 7 | 4 |
| G. パフォーマンス最適化 | 1 | 3 | 4 |
| H. 堅牢性・障害解析 | 5 | 2 | 1 |
| I. バランス・コンテンツ拡張 | 0 | 3 | 5 |
| J. 開発体験・運用 | 1 | 3 | 3 |
| K. ドキュメント同期タスク | 2 | 3 | 0 |
| **合計** | **20** | **39** | **21** |
