# TODO — Emojimon 改善リスト

ソースコード全体を精読し、改善点を網羅的に洗い出したリストです。  
優先度は **高 / 中 / 低** の3段階で分類しています。

---

## 凡例

- 🔴 高: バグ・データ不整合・機能欠落など、ゲーム進行やデータ信頼性に直結する問題
- 🟡 中: コード品質・テスト不足・UX改善など、保守性や体験品質に影響する問題
- 🟢 低: パフォーマンス最適化・堅牢性強化など、現時点で実害は小さいが将来的に対処すべき問題

---

## A. バグ・エラーリスク 🔴

- [ ] **A-01** `selfHealPercent` vs `selfHealRatio` の不一致 — `battleTurnFlow.ts` の `handleStatusMove()` は `move.selfHealPercent` を参照するが、型定義 (`game.d.ts`) は `selfHealRatio`。回復技が常に不発の可能性がある
- [ ] **A-02** 伝説モンスター戦で `legendaryDefeated` がバトル前にセットされる — `WorldScene.ts` の `_doGardenLegendary()` で戦闘開始前にフラグ保存。逃走・敗北しても再挑戦不可
- [ ] **A-03** `AudioManager.init()` の初期化レースコンディション — `this._initialized = true` 設定後に `await Tone.start()` を呼び出し。非同期処理完了前にBGM再生が試行される恐れ
- [ ] **A-04** ダイアログリスナーの多重登録リスク — `WorldScene.ts` `showDialogSequence()` で `this.keys.Z.on("down", ...)` 登録時の前回リスナー解除タイミングに競合の余地
- [ ] **A-05** 実績 `WIN_STREAK_5` / `WIN_STREAK_10` の判定条件が名前と不一致 — 「連勝」を意味する名前だが、実際は `totalBattles` の累計（25回/75回）を判定
- [ ] **A-06** 闘技場の `_arenaRound` が `gameState` に正式プロパティ未定義 — `worldTrainerArena.ts` で直接操作しているが、セーブ/ロード時に値が消失する可能性
- [ ] **A-07** `bagView.ts` のモンスター名がニックネーム未対応 — バッグ画面のターゲット選択で `mon.species.name` を直接使用。`partyView.ts` では `mon.nickname || mon.species.name` を使用しており不統一
- [ ] **A-08** エンカウント演出中のシーン `pause()` 後にオーバーレイ/パーティクルが残存する可能性 — バトル復帰時にゴーストオブジェクトになりうる
- [ ] **A-09** `settingsView.ts` の `removeAllListeners("down")` による副作用 — 左右キーの全リスナーを除去してから登録するため、他ビューのリスナーが失われるリスク

---

## B. データ・型定義の不整合 🔴

- [ ] **B-01** `game.d.ts` の `Move.category` 型が実データと不一致 — 型: `"attack" | "status"` → 実データ: `"physical" | "special" | "status"`
- [ ] **B-02** `game.d.ts` の `MapKey` 型が不完全 — 7キーのみ定義だが実際は25+マップが存在
- [ ] **B-03** `game.d.ts` の `TileCode` 型が不完全 — `0-7` のみだが、実装では `T.POISON=8` 〜 `T.SAND=12` を使用
- [ ] **B-04** `game.d.ts` の `MonsterSpecies.learnset` 型が `Move[]` だが実データは `{move: string, level: number}[]` — 型定義と実構造の齟齬
- [ ] **B-05** `game.d.ts` の `NpcDef` 型と実装のNPCフィールドが不一致 — `dialog` vs `text`, `shopkeeper` vs `shop` 等
- [ ] **B-06** `abilities.json` の `STURDY` 特性がコード上で未実装 — `battleCalcStatus.ts` に対応ロジックがない（HP1残し効果等）
- [ ] **B-07** 副タイプ (`secondaryType`) の二重相性計算が未実装 — 防御側の `secondaryType` による二重相性（`0.5×0.5=0.25` 等）が考慮されていない
- [ ] **B-08** `game.d.ts` の `selfHealRatio` / `targetDefenseStage` 等の定義が実装と乖離 — 使用されていないフィールドや名前違いが混在

---

## C. 機能欠落・未実装 🔴

- [ ] **C-01** `dataValidation.ts` で新規6マップの出現プール検証が欠落 — `swampPool`, `coralPool`, `sandValleyPool`, `shadowGrovePool`, `libraryPool`, `basinPool` が検証対象外
- [ ] **C-02** `AudioManager.playAreaBgm()` が新規マップに未対応 — 6マップがデフォルトBGMにフォールバック。マップ固有BGMが再生されない
- [ ] **C-03** PP回復アイテムの個別技選択UIがバトル外メニューに未実装 — エーテル/メガエーテルを所持していても、どの技に使うか選べない
- [ ] **C-04** ボックスのソート・フィルター機能なし — モンスター数が増えると管理が困難になる
- [ ] **C-05** バッグ画面にスクロール機能なし — アイテムリストが画面外に溢れた場合の制御がない
- [ ] **C-06** ワールドマップにファストトラベル機能なし — 訪問済みマップの閲覧のみ。後半のマップ移動が冗長
- [ ] **C-07** 技カテゴリの `"physical"` / `"special"` の区別がダメージ計算に反映されていない — `category` フィールドは存在するが攻撃/防御ステの使い分けが不明瞭
- [ ] **C-08** 日替わりチャレンジが3パターンのみ — `CATCH_3`, `BATTLE_5`, `ARENA_CLEAR` のループでバリエーション不足

---

## D. コード品質 🟡

- [ ] **D-01** `WorldScene.ts` が3094行で巨大 — 移動/NPC対話/ストーリーイベント(30+分岐)/ジムバトル/エンカウント等が全て1ファイル。AGENTS.md §7「1ファイル1責務」に違反
- [ ] **D-02** `worldMapData.ts` が1873行 — 25マップのレイアウト配列+NPC定義+ドア遷移テーブル。JSONまたは個別ファイルへの外出しを検討
- [ ] **D-03** `pickByWeight()` 関数が `monsters.ts` と `wildEncounters.ts` に重複 — 共通ユーティリティに統合すべき
- [ ] **D-04** TypeScript の型注釈不足 — `BattleScene.ts`, `WorldScene.ts`, `gameState.ts` 等のクラスプロパティ・メソッド引数に型注釈がない
- [ ] **D-05** `items.ts` の `initItems()` 初期化パターンが他ファイルと不統一 — `monsters.ts` / `moves.ts` はクリア後に追加、`items.ts` は上書き
- [ ] **D-06** `wildEncounters.ts` のプール変数が14個の個別変数 — マップキー→プールの `Record` で統一可能
- [ ] **D-07** `MenuSceneLike` 型が `menuSceneNickname.ts` だけにローカル定義 — 他のビュー関数の `scene` 引数も型なし。共通型を定義して一元化すべき
- [ ] **D-08** 設定値のマジックナンバー散在 — バトル定数、UI座標、アニメーション時間等がハードコード値のまま。定数化不足
- [ ] **D-09** `WorldScene.ts` のストーリーイベント分岐が30+の if/else チェーン — テーブル駆動やストラテジパターンでの整理を検討
- [ ] **D-10** NPCの会話テキストがソースコード内にハードコード — データファイル（JSON等）への外出しで翻訳・修正を容易に

---

## E. テスト不足 🟡

- [ ] **E-01** テスト数が全体で6ファイル・21テストのみ — カバレッジツール未導入
- [ ] **E-02** ダメージ計算 (`calculateDamage()`) のテストなし — ゲームバランスの根幹に関わる
- [ ] **E-03** 捕獲率計算 (`battleCatch.ts`) のテストなし — HP/状態異常/ボール種別の補正が正しいか検証されていない
- [ ] **E-04** 進化ロジック (`evolution.ts`) のテストなし — レベル進化・アイテム進化の判定未検証
- [ ] **E-05** 実績解除条件 (`achievements.ts`) のテストなし — A-05のバグも検出されていない
- [ ] **E-06** ワイルドエンカウンター生成のテストなし — マップごとのプール抽選が正しいか未検証
- [ ] **E-07** セーブ/ロードの互換性テストなし — Zodスキーマに対する異常データ・バージョン間互換テスト未実装
- [ ] **E-08** UI描画・インタラクションのテストなし — メニュー/バトル/ショップの操作テストが皆無

---

## F. UX・ゲーム体験改善 🟡

- [ ] **F-01** ショップ売却時にアイテム説明が表示されない — 購入時は価格表示があるが売却時は半額表記のみ
- [ ] **F-02** 戦闘速度設定が3段階のみ（NORMAL/FAST/TURBO） — 細かい中間値がなくユーザー好みに合わない場合がある
- [ ] **F-03** パーティ画面の技表示位置がハードコード — 詳細テキストが長い場合にレイアウトが崩れる可能性
- [ ] **F-04** 図鑑画面にモンスターのスペック比較・検索機能なし — タイプ別フィルタや名前検索がない
- [ ] **F-05** バトル中に相手モンスターのタイプを確認する手段がない — 戦略的判断が難しい
- [ ] **F-06** モンスターの個体値・努力値などの個性要素がない — やりこみ要素の不足
- [ ] **F-07** 交換（トレード）機能がない — モンスター収集の導線が捕獲のみに限定
- [ ] **F-08** NPCの再戦機能がない — 経験値稼ぎの手段が野生バトルのみ
- [ ] **F-09** タイプ相性表をゲーム内で確認する手段がない — ガイドやメニューに相性チャートがあると初心者に優しい
- [ ] **F-10** マップ内でのアイテム拾得ポイントの視覚的ヒントが弱い — 隠しアイテムが見つけにくい
- [ ] **F-11** バトル終了後のリザルト画面が簡素 — 獲得経験値・報酬の内訳表示が不十分
- [ ] **F-12** 模様替え・カスタマイズ要素がない — プレイヤーアバターの変更やホーム画面のカスタマイズなど
- [ ] **F-13** 図鑑完成報酬がない — 図鑑埋めのモチベーション不足
- [ ] **F-14** バトル中のPP残量表示が不明瞭 — 残PPが少ない技の視覚的警告がない
- [ ] **F-15** モンスター合成のUI導線が弱い — 合成可能な組み合わせをプレイヤーが発見しにくい

---

## G. パフォーマンス 🟢

- [ ] **G-01** `update()` 内の `encounterCooldown` 減算が5箇所に散在 — フロー末尾で一括処理すべき
- [ ] **G-02** NPCスプライトの毎回全破棄・再生成 — マップ変更なしの `createUi()` 呼び出し時にも全再生成。差分更新の仕組みがない
- [ ] **G-03** `worldMapData.ts` の全25マップ分タイル配列がメモリ常駐 — 現在マップ以外は遅延ロード可能
- [ ] **G-04** `gameState.save()` が毎回フルシリアライズ — 50+モンスターのボックス含む場合、バトル毎にフル `JSON.stringify()`。差分保存検討
- [ ] **G-05** 図鑑画面の `seenIds.includes()` が O(n) ルックアップ — 50+モンスターの各行で毎回検索。`Set` に変換すべき
- [ ] **G-06** `getMonsterMoves()` の繰り返し呼び出し — パーティ回復処理で全メンバーに対して毎回 learnset をフィルタリング
- [ ] **G-07** バトルUI再描画の最適化 — ステータスバー等が毎フレーム再描画されている可能性。変更検知による差分更新を検討

---

## H. セキュリティ・堅牢性 🟢

- [ ] **H-01** `localStorage` に平文でセーブデータ保存 — ブラウザコンソールから直接編集可能（チート容易）
- [ ] **H-02** プレイヤー名の入力サニタイズ不十分 — 最大8文字制限はあるが特殊文字（絵文字、制御文字）のフィルタリングなし
- [ ] **H-03** `Tone.js` の例外を握り潰す `try/catch` が3箇所 — 音が出ない問題の原因特定が困難
- [ ] **H-04** RexUI プラグインの graceful degradation 不完全 — 部分的ロード失敗時のクラッシュリスク
- [ ] **H-05** ボックスサイズ上限チェックなしの `push()` — `addEternaToParty()` 等でMAX_BOX_SIZE超過の可能性
- [ ] **H-06** バックアップ復元パスでの `JSON.parse()` 例外ハンドリングが不完全な可能性

---

## I. ゲームバランス・コンテンツ拡充 🟡

- [ ] **I-01** ICEタイプのモンスター/技のバリエーション不足 — 他タイプに比べて選択肢が少ない
- [ ] **I-02** NORMALタイプの戦略的役割が薄い — 弱点が少ない以外の特徴がない
- [ ] **I-03** ポストゲームコンテンツの薄さ — 四天王クリア後のやりこみ要素が限定的
- [ ] **I-04** エリア間のレベル曲線ギャップ — 一部エリア間でレベル帯の跳躍が大きい（例: DARK_TOWER 18-24 → SHADOW_GROVE 20-26 は近いが、CELESTIAL_GARDEN 25-35 → STARFALL_BASIN 35-45 は広い）
- [ ] **I-05** 状態異常の種類が5種で少ない — 混乱、メロメロ、ひるみ等の追加で戦略幅が広がる
- [ ] **I-06** ダブルバトル・マルチバトルなし — バトルの多様性が単体戦のみ
- [ ] **I-07** 天候を活用する技がほぼない — 天候連動技（ソーラービーム的な技）でシステムを活かすべき
- [ ] **I-08** ボスバトルの特別ギミックなし — 通常バトルと構造が同じでボス感が薄い

---

## J. 開発体験・保守性 🟢

- [ ] **J-01** カバレッジレポート未導入 — `vitest --coverage` 等でカバレッジを可視化すべき
- [ ] **J-02** CI/CD パイプラインなし — GitHub Actions 等で lint/typecheck/test/build の自動実行を検討
- [ ] **J-03** ホットリロード時のシーン状態復元なし — 開発中にシーン状態が失われる
- [ ] **J-04** デバッグモード/チートコンソール未実装 — テスト時のゲーム進行高速化手段がない
- [ ] **J-05** ゲームバランス調整ツールなし — モンスター/技のパラメータ比較や勝率シミュレーションツールがない
- [ ] **J-06** エラーログの外部送信/集約なし — ユーザー環境で発生するエラーの把握が困難
- [ ] **J-07** `package-lock.json` がリポジトリに含まれていない — 依存バージョンの再現性が不完全

---

## 統計サマリー

| カテゴリ | 件数 | 優先度 |
|---|---|---|
| A. バグ・エラーリスク | 9件 | 🔴 高 |
| B. データ・型定義不整合 | 8件 | 🔴 高 |
| C. 機能欠落・未実装 | 8件 | 🔴 高 |
| D. コード品質 | 10件 | 🟡 中 |
| E. テスト不足 | 8件 | 🟡 中 |
| F. UX・ゲーム体験改善 | 15件 | 🟡 中 |
| G. パフォーマンス | 7件 | 🟢 低 |
| H. セキュリティ・堅牢性 | 6件 | 🟢 低 |
| I. ゲームバランス・コンテンツ | 8件 | 🟡 中 |
| J. 開発体験・保守性 | 7件 | 🟢 低 |
| **合計** | **86件** | |
